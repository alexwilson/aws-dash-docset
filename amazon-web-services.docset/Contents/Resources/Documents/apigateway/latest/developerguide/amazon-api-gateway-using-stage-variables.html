<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Use
         Amazon API Gateway Stage Variables - Amazon API Gateway
      </title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="home" href="#top">
      <link rel="up" href="stage-variables.html" title="Set up Stage Variable for API Deployment">
      <link rel="prev" href="how-to-set-stage-variables-aws-console.html" title="Set Stage Variables Using the
      Amazon API Gateway Console">
      <link rel="next" href="aws-api-gateway-stage-variables-reference.html" title="Amazon API Gateway Stage Variables Reference">
      <meta name="description" content="You can use API Gateway stage variables to access the HTTP and Lambda backends for different API deployment stages and to pass stage-specific configuration metadata into an HTTP backend as a query parameter and into a Lambda function as a payload generated in an input mapping template.">
      <meta name="deployment_region" content="IAD">
      <meta name="product" content="Amazon API Gateway">
      <meta name="guide" content="Developer Guide">
      <meta name="guide-locale" content="en_us">
      <link rel="icon" type="image/ico" href="/images/favicon.ico">
      <link rel="shortcut icon" type="image/ico" href="/images/favicon.ico">
      <link rel="canonical" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/amazon-api-gateway-using-stage-variables.html">
      <link rel="stylesheet" type="text/css" href="../../../css/jquery-ui.min.css">
      <link rel="stylesheet" type="text/css" href="../../../css/font-awesome.min.css">
      <link rel="stylesheet" type="text/css" href="../../../css/google-font.css">
      <link id="code-style" rel="stylesheet" type="text/css" href="../../../css/light.css">
      <link rel="stylesheet" type="text/css" href="../../../css/jquery-ui.theme.css">
      <link rel="stylesheet" type="text/css" href="../../../css/colorbox.css">
      <link rel="stylesheet" type="text/css" href="../../../css/awsdocs.css"><script type="text/javascript" src="/js/highlight.pack.js"></script><script type="text/javascript" src="/js/jquery.min.js"></script><script type="text/javascript" src="/js/jquery-ui.min.js"></script><script type="text/javascript" src="/js/handlebars.js"></script><script type="text/javascript" src="/js/jquery.colorbox.js"></script><script type="text/javascript" src="/js/awsdocs.min.js?v=20170615"></script></head>
   <body id="top">
      
      <div id="content-container">
         
         <div id="main-column">
            <div id="main">
               <div id="main-content">
                  <div id="main-col-body">
                     <table summary="Breadcrumbs">
                        <tbody><tr>
                           <td>
                              <div class="breadcrumb"><a href="http://aws.amazon.com/documentation">AWS Documentation</a> &#xBB; <a href="http://aws.amazon.com/documentation/apigateway">Amazon API Gateway</a> &#xBB; <a href="index.html">Developer Guide</a> &#xBB; <a href="how-to-deploy-api.html">Deploying an API in Amazon API Gateway</a> &#xBB; <a href="set-up-stages.html">Set up a Stage in API Gateway</a> &#xBB; <a href="stage-variables.html">Set up Stage Variable for API Deployment</a> &#xBB; <span class="breadcrumb">Use
                                    Amazon API Gateway Stage Variables</span></div>
                           </td>
                        </tr>
                     </tbody></table>
                     <div></div>
                     <h1 class="topictitle" id="amazon-api-gateway-using-stage-variables">Use
                        Amazon API Gateway Stage Variables
                     </h1>
                     <p>You
                        can use API Gateway stage variables to access the HTTP and Lambda backends for different
                        API
                        deployment stages and to pass stage-specific configuration metadata into an HTTP backend
                        as a
                        query parameter and into a Lambda function as a payload generated in an input mapping
                        template.
                        
                     </p>
                     <h2 id="using-stage-variables-prerequisites">Prerequisites</h2>
                     
                     
                     <p>You must create two stages with a <code class="code">url</code> variable set to two different HTTP
                        endpoints: a <code class="code">function</code> stage variable assigned to two different Lambda functions,
                        and a <code class="code">version</code> stage variable containing  stage-specific metadata. Follow the
                        instructions in <a href="how-to-set-stage-variables-aws-console.html">Set Stage Variables Using the
                           Amazon API Gateway Console</a>.
                     </p>
                     
                     <h2 id="call-api-http-backend-via-stage-variable">Access an HTTP endpoint through an
                        API with a stage variable
                     </h2>
                     
                     
                     
                     
                     <ol>
                        <li>
                           
                           <p>In the <b>Stages</b> navigation pane, choose
                              <b>beta</b>. In <b>beta Stage Editor</b>, choose the
                              <b>Invoke URL</b> link. This starts the
                              <b>beta</b>
                              stage <code class="code">GET</code> request on the root resource of the API. 
                           </p>
                           
                           <div class="aws-note">
                              <p class="aws-note">Note</p>
                              <p>The <b>Invoke URL</b> link points to the root resource of the API in
                                 its <b>beta</b> stage. Navigating to the URL by choosing the link calls
                                 the <b>beta</b> stage <code class="code">GET</code> method on the root resource. If
                                 methods are defined on child resources and not on the root resource itself, choosing
                                 the <b>Invoke URL</b> link will return a <code class="code">{&quot;message&quot;:&quot;Missing
                                    Authentication Token&quot;}</code> error response. In this case, you must append the name
                                 of a specific child resource to the <b>Invoke URL</b> link. 
                              </p>
                           </div>
                           
                           
                        </li>
                        <li>
                           
                           <p>The response you get from the <b>beta</b> stage <code class="code">GET</code>
                              request is shown next.
                              You
                              can also verify the result by using a browser to navigate to
                              <b>http://httpbin.org/get</b>. This value was
                              assigned to the <code class="code">url</code> variable in the <b>beta</b> stage. The
                              two responses are identical. 
                           </p>
                                   
                           
                        </li>
                        <li>
                           
                           <p>In the <b>Stages</b> navigation pane, choose the
                              <b>prod</b> stage. From <b>prod Stage Editor</b> , choose
                              the <b>Invoke URL</b> link. This starts the <b>prod</b>
                              stage <code class="code">GET</code> request on the root resource of the API. 
                           </p>
                           
                           
                        </li>
                        <li>
                           
                           <p>The response you get from the <b>prod</b> stage <code class="code">GET</code>
                              request is shown next. You can verify the result
                              by
                              using a browser to navigate to
                              <b>http://petstore-demo-endpoint-execute-api.com/petstore/pets</b>.
                              This value was assigned to the <code class="code">url</code> variable in the
                              <b>prod</b> stage. The two responses are identical. 
                           </p>
                           
                           
                        </li>
                     </ol>
                     
                     <h2 id="call-api-http-backend-with-query-parameter-via-stage-variables">Pass
                        stage-specific metadata to an HTTP backend via a stage variable in a query parameter
                        expression
                     </h2>
                     
                     
                     <p>This procedure describes how to use a stage variable value in a query parameter
                        expression to pass  stage-specific metadata into an HTTP back
                        end. We will use the <code class="code">version</code> stage variable declared
                        in
                        <a href="how-to-set-stage-variables-aws-console.html">Set Stage Variables Using the
                           Amazon API Gateway Console</a>.
                        
                     </p>
                     
                     <ol>
                        <li>
                           
                           <p>In the <b>Resource</b> navigation pane, choose the
                              <b>GET</b> method. To add a query string parameter to the method&apos;s URL,
                              in <b>Method Execution</b>, choose <b>Method Request</b> .
                              Type <b>version</b> for the parameter name. 
                           </p>
                           
                           
                           <div class="mediaobject">
                              
                              <img src="../../..//img/stageVariables-add-query-string-parameter-to-method-request.png" alt="
                  Add a version query string parameter to an HTTP GET
                    method.
                " style="max-width:100%">
                              
                              
                              
                           </div>         
                           
                        </li>
                        <li>
                           
                           <p> In <b>Method Execution</b> choose <b>Integration
                                 Request</b>. Edit the <b>Endpoint URL</b> value to append
                              <code class="code">?version=${stageVariables.version}</code> to the previously defined URL value,
                              which, in this case, is also expressed with the <code class="code">url</code> stage variable. Choose
                              <b>Deploy API</b> to deploy these changes. 
                           </p>
                           
                           <div class="mediaobject">
                              
                              
                              <img src="../../..//img/stageVariables-add-query-string-parameter-expression-with-version-variable.png" alt="
                  Append a query string expression with the version stage 
                    variable to an HTTP endpoint URL
                " style="max-width:100%">
                              
                              
                              
                           </div>         
                           
                        </li>
                        <li>
                           
                           <p>In the <b>Stages</b> navigation pane, choose the
                              <b>beta</b> stage. From <b>beta Stage Editor</b>, verify
                              that the current stage is in the most recent deployment, and then choose the
                              <b>Invoke URL</b> link. 
                           </p>
                           
                           <div class="aws-note">
                              <p class="aws-note">Note</p>
                              <p> We use the beta stage here because the HTTP endpoint, as specified by the
                                 <code class="code">url</code> variable, &quot;http://httpbin.org/get&quot;, accepts query parameter
                                 expressions and returns them as the <code class="code">args</code> object in its response. 
                              </p>
                           </div>
                           
                           
                        </li>
                        <li>
                           
                           <p>The response is shown next. Notice that <code class="code">v-beta</code>, assigned to the
                              <code class="code">version</code> stage variable, is passed in the backend as the
                              <code class="code">version</code> argument. 
                           </p>
                           
                           <div class="mediaobject">
                              
                              <img src="../../..//img/stageVariables-invoke-beta-stage-with-url-and-version-variables-response.png" alt="
                  Response from the API&apos;s GET method using a proxy for an HTTP
                    endpoint with the url stage variable in the
                      beta
                    stage
                " style="max-width:100%">
                              
                              
                              
                              
                           </div>         
                           
                        </li>
                     </ol>
                     
                     <h2 id="call-api-lambda-backend-with-stage-variable">Call Lambda function through API
                        with a stage variable
                     </h2>
                     
                     
                     <p>This procedure describes how to use a stage variable to call a Lambda function as
                        a back
                        end of your API. We will use the <code class="code">function</code> stage variable declared earlier. For
                        more information, see <a href="how-to-set-stage-variables-aws-console.html">Set Stage Variables Using the
                           Amazon API Gateway Console</a>.
                     </p>
                     
                     <ol>
                        <li>
                           
                           <p>In the <b>Resources</b> pane, create a <b>/lambdasv1</b>
                              child resource under the root directory, and  then create a <code class="code">GET</code> method on
                              the child resource. Set the <b>Integration type</b> to <b>Lambda
                                 Function</b>, and in <b>Lambda Function</b>, type
                              <code class="code">${stageVariables.function}</code> . Choose <b>Save</b>. 
                           </p>
                           
                           <div class="mediaobject">
                              
                              
                              <img src="../../..//img/stageVariables-create-lambda-get-method.png" alt="
                  Create a GET method integrated with a Lambda function as specified by the
                    function stage variable.
                " style="max-width:100%">
                              
                              
                              
                           </div> 
                           
                           
                           <div class="aws-note">
                              <p class="aws-note">Tip</p>
                              <p>When prompted with <b>Add Permision to Lambda Function</b>, make a
                                 note of the AWS CLI command before choosing <b>OK</b>. You must run
                                 the command on each Lambda function that is or will be assigned to the
                                 <code class="code">function</code> stage variable for each of the newly created API methods. For 
                                 example, if the <code class="code">$stageVariables.function</code> value is <code class="code">HelloWorld</code>
                                 and you have not added permission to this function yet, you must run the following
                                 
                                 AWS CLI command:
                                 
                              </p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">aws lambda add-permission --function-name arn:aws:lambda:us-east-1:<em class="replaceable"><code>account-id</code></em>:function:HelloWorld --source-arn arn:aws:execute-api:us-east-1:<em class="replaceable"><code>account-id</code></em>:<em class="replaceable"><code>api-id</code></em>/*/GET/lambdasv1 --principal apigateway.amazonaws.com --statement-id <em class="replaceable"><code>statement-id-guid</code></em> --action lambda:InvokeFunction</code></pre><p>
                                 Failing to do so results in a <code class="code">500 Internal Server Error</code> response when
                                 invoking the method. Make sure to replace <code class="code">${stageVariables.function}</code> with
                                 the  Lambda function name that is assigned to the stage variable. 
                              </p>
                              <div class="mediaobject">
                                 
                                 <img src="../../..//img/stageVariables-add-permission-to-lambda-function.png" alt="
                    Run the AWS CLI command to add permission to the Lambda function to be
                      invoked by method you just created. 
                  " style="max-width:100%">
                                 
                                 
                                 
                              </div>
                           </div>
                           
                           
                        </li>
                        <li>
                           
                           <p>
                              Deploy the API to available stages.
                              
                           </p>         
                           
                        </li>
                        <li>
                           
                           <p>In
                              the <b>Stages</b> navigation pane, choose the <b>beta</b>
                              stage. Verify that your most recent deployment is in
                              <b>beta
                                 Stage Editor</b>. Copy the <b>Invoke URL</b> link, paste it into
                              the address bar of your browser, and append <code class="code">/lambdasv1</code> to that URL. This
                              calls the underlying Lambda function through the <code class="code">GET</code> method on the
                              <b>LambdaSv1</b> child resource of the API. 
                           </p>
                           
                           <div class="aws-note">
                              <p class="aws-note">Note</p>
                              <p>Your
                                 <code class="code">HelloWorld</code> Lambda function implements the following
                                 code. 
                              </p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">
exports.handler = function(event, context, callback) {
    if (event.version)
        callback(null, &apos;Hello, World! (&apos; + event.version + &apos;)&apos; );
    else
        callback(null, &quot;Hello, world! (v-unknown)&quot;);  
};
            </code></pre><p>This implementation results in the following response.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">&quot;Hello, world! (v-unknown)&quot;</code></pre></div>
                           
                        </li>
                     </ol>
                     
                     <h2 id="pass-version-info-to-lambda-backend-with-stage-variable">Pass stage-specific metadata to a Lambda function via a stage variable</h2>
                     
                     
                     <p>This procedure describes how to use a stage variable to pass stage-specific
                        configuration metadata into a Lambda function. We will use a <code class="code">POST</code> method and an
                        input mapping template to generate payload using the <code class="code">version</code> stage variable
                        declared earlier.
                     </p>
                     
                     <ol>
                        <li>
                           
                           <p>In the <b>Resources</b> pane, choose the
                              <b>/lambdasv1</b> child resource. Create a <code class="code">POST </code> method on
                              the child resource, set the <b>Integration type</b> to <b>Lambda
                                 Function</b>, and type <code class="code">${stageVariables.function}</code> in
                              <b>Lambda Function</b>. Choose <b>Save</b>. 
                           </p>
                           
                           <div class="aws-note">
                              <p class="aws-note">Tip</p>
                              <p><code class="code"></code>This step is similar to the step we used to create the <code class="code">GET</code>
                                 method. For more information, see <a href="amazon-api-gateway-using-stage-variables.html#call-api-lambda-backend-with-stage-variable">Call Lambda function through API
                                    with a stage variable</a>. 
                              </p>
                           </div>
                           
                           
                        </li>
                        <li>
                           
                           <p> From the
                              <b>/Method
                                 Execution</b> pane, choose <b>Integration
                                 Request</b>. In the <b>Integration Request</b> pane, expand
                              <b>Mapping Templates</b>, and then choose <b>Add mapping
                                 template</b> to add a template for the <code class="code">application/json</code>
                              content-type, as shown in the following. 
                           </p>
                           
                           <div class="mediaobject">
                              
                              <img src="../../..//img/stageVariables-generate-post-payload-with-mapping-template-as-input-to-function.png" alt="
                  Generate a POST method payload, containing stage-specific
                    configuration metadata represented by the version stage variable
                    value, as an input to the backend Lambda function. 
                " style="max-width:100%">
                              
                              
                              
                           </div> 
                           
                           <div class="aws-note">
                              <p class="aws-note">Note</p>
                              <p> In a mapping template, a stage variable must be referenced within quotes (as in
                                 <code class="code">&quot;$stageVariables.version&quot;</code> or <code class="code">&quot;${stageVariables.version}&quot;</code>),
                                 whereas elsewhere it must be referenced without quotes (as in
                                 <code class="code">${stageVariables.function}</code>). 
                              </p>
                           </div>
                           
                        </li>
                        <li>
                           
                           <p>
                              Deploy the API to available stages.
                              
                           </p>         
                           
                        </li>
                        <li>
                           
                           <p>In the <b>Stages</b> navigation pane, choose
                              <b>beta</b>. In <b>beta Stage Editor</b> , verify that the
                              current stage has the most recent deployment. Copy the <b>Invoke URL</b>
                              link, paste it into the URL input field of a REST API client, append
                              <code class="code">/lambdasv1</code> to that URL, and then submit a <code class="code">POST</code> request to
                              the underlying Lambda function. 
                           </p>
                           
                           <div class="aws-note">
                              <p class="aws-note">Note</p>
                              <p>You will get the following response.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">&quot;Hello, world! (v-beta)&quot;</code></pre></div>
                           
                        </li>
                     </ol>
                     
                     
                     <p>
                        To summarize, we have demonstrated how to use API Gateway stage variables to target
                        different HTTP
                        and Lambda back
                        ends for different stages of API deployment. In addition, we also showed how
                        to use the stage variables to pass stage-specific configuration data into HTTP and
                        Lambda back
                        ends. Together, these procedures demonstrate the versatility of the API Gateway
                        stage variables in managing API development. 
                     </p>
                     
                     
                  </div>
                  <noscript>
                     <div>
                        <div>
                           <div>
                              <div id="js_error_message">
                                 <p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p>
                                 <p>To use the AWS Documentation, Javascript must be enabled. Please refer to your browser's
                                    Help pages for instructions.
                                 </p>
                              </div>
                           </div>
                        </div>
                     </div>
                  </noscript>
                  <div id="main-col-footer">
                     <div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div>
                     <div id="next"><a class="awstoc" accesskey="p" href="how-to-set-stage-variables-aws-console.html">&#xAB; Previous </a><a class="awstoc" accesskey="n" href="aws-api-gateway-stage-variables-reference.html">Next &#xBB;</a></div>
                     <div id="copyright-main-footer">&#xA9; 2018, Amazon Web Services, Inc. or its affiliates. All rights reserved.</div>
                  </div>
               </div>
            </div>
            <div id="right-expanded">
               <div id="right-content-wrapper">
                  <div id="pagetoc">
                     <p>On this page:</p>
                     <ul class="pagetoc">
                        <li class="pagetoc" name="Prerequisites"><a class="pagetoc" href="#using-stage-variables-prerequisites">Prerequisites</a></li>
                        <li class="pagetoc" name="Access an HTTP endpoint through an
        API with a stage variable"><a class="pagetoc" href="#call-api-http-backend-via-stage-variable">Access an HTTP endpoint through an
                              API with a stage variable</a></li>
                        <li class="pagetoc" name="Pass
        stage-specific metadata to an HTTP backend via a stage variable in a query parameter
        expression"><a class="pagetoc" href="#call-api-http-backend-with-query-parameter-via-stage-variables">Pass
                              stage-specific metadata to an HTTP backend via a stage variable in a query parameter
                              expression</a></li>
                        <li class="pagetoc" name="Call Lambda function through API
        with a stage variable"><a class="pagetoc" href="#call-api-lambda-backend-with-stage-variable">Call Lambda function through API
                              with a stage variable</a></li>
                        <li class="pagetoc" name="Pass stage-specific metadata to a Lambda function via a stage variable"><a class="pagetoc" href="#pass-version-info-to-lambda-backend-with-stage-variable">Pass stage-specific metadata to a Lambda function via a stage variable</a></li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      </div>
      
      <!-- SiteCatalyst code version: H.25.2.
            Copyright 1996-2012 Adobe, Inc. All Rights Reserved
            More info available at http://www.omniture.com --><script language="JavaScript" type="text/javascript" src="https://a0.awsstatic.com/s_code/js/1.0/awshome_s_code.js"></script><script language="JavaScript" type="text/javascript">
         <!--

            // Documentation Service Name
            s.prop66='Amazon API Gateway';
            s.eVar66='D=c66';
  
            // Documentation Guide Name                                                                 
            s.prop65='Developer Guide';
            s.eVar65='D=c65';

            var s_code=s.t();if(s_code)document.write(s_code)//--></script><script language="JavaScript" type="text/javascript">
         <!--
                if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
                //--></script><noscript><img src="https://amazonwebservices.d2.sc.omtrdc.net/b/ss/awsamazondev/1/H.25.2--NS/0" height="1" width="1" border="0" alt="" /></noscript>
      <!--/DO NOT REMOVE/-->
      <!-- End SiteCatalyst code version: H.25.2. -->
   
</body></html>