<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Protecting Data Using Client-Side
         			Encryption - Amazon Simple Storage Service
      </title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="home" href="#top">
      <link rel="up" href="UsingEncryption.html" title="Protecting Data Using Encryption">
      <link rel="prev" href="ServerSideEncryptionCustomerKeysSSEUsingRESTAPI.html" title="Specifying Server-Side Encryption with Customer-Provided Encryption Keys Using the REST API">
      <link rel="next" href="Versioning.html" title="Using Versioning">
      <meta name="description" content="Protect data using client-side encryption.">
      <meta name="deployment_region" content="IAD">
      <meta name="product" content="Amazon Simple Storage Service">
      <meta name="guide" content="Developer Guide">
      <meta name="guide-locale" content="en_us">
      <link rel="icon" type="image/ico" href="/images/favicon.ico">
      <link rel="shortcut icon" type="image/ico" href="/images/favicon.ico">
      <link rel="canonical" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingClientSideEncryption.html">
      <link rel="stylesheet" type="text/css" href="../../../css/jquery-ui.min.css">
      <link rel="stylesheet" type="text/css" href="../../../css/font-awesome.min.css">
      <link rel="stylesheet" type="text/css" href="../../../css/google-font.css">
      <link id="code-style" rel="stylesheet" type="text/css" href="../../../css/light.css">
      <link rel="stylesheet" type="text/css" href="../../../css/jquery-ui.theme.css">
      <link rel="stylesheet" type="text/css" href="../../../css/colorbox.css">
      <link rel="stylesheet" type="text/css" href="../../../css/awsdocs.css"><script type="text/javascript" src="/js/highlight.pack.js"></script><script type="text/javascript" src="/js/jquery.min.js"></script><script type="text/javascript" src="/js/jquery-ui.min.js"></script><script type="text/javascript" src="/js/handlebars.js"></script><script type="text/javascript" src="/js/jquery.colorbox.js"></script><script type="text/javascript" src="/js/awsdocs.min.js?v=20170615"></script></head>
   <body id="top">
      
      <div id="content-container">
         
         <div id="main-column">
            <div id="main">
               <div id="main-content">
                  <div id="main-col-body">
                     <table summary="Breadcrumbs">
                        <tbody><tr>
                           <td>
                              <div class="breadcrumb"><a href="http://aws.amazon.com/documentation">AWS Documentation</a> &#xBB; <a href="http://aws.amazon.com/documentation/s3">Amazon Simple Storage Service (S3)</a> &#xBB; <a href="index.html">Developer Guide</a> &#xBB; <a href="DataDurability.html">Protecting Data in Amazon S3</a> &#xBB; <a href="UsingEncryption.html">Protecting Data Using Encryption</a> &#xBB; <span class="breadcrumb">Protecting Data Using Client-Side
                                    			Encryption</span></div>
                           </td>
                        </tr>
                     </tbody></table>
                     <div></div>
                     <h1 class="topictitle" id="UsingClientSideEncryption">Protecting Data Using Client-Side
                        			Encryption
                     </h1>
                     <p><em>Client-side encryption</em> is the act of encrypting data
                        		before sending it to Amazon S3. To enable client-side encryption, you have the following
                        		options:
                     </p>
                     <div class="itemizedlist">
                        		
                        		
                        	
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              			
                              <p>Use
                                 				an AWS KMS-managed customer master key
                              </p>
                              		
                           </li>
                           <li class="listitem">
                              			
                              <p>Use a client-side master key</p>
                              		
                           </li>
                        </ul>
                     </div>
                     <p>The
                        		following AWS SDKs support client-side encryption:
                     </p>
                     <div class="itemizedlist">
                        		
                        		
                        		
                        		
                        		
                        	
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              			
                              <p><a href="https://aws.amazon.com/sdk-for-net/" target="_blank">AWS SDK for .NET</a></p>
                              		
                           </li>
                           <li class="listitem">
                              			
                              <p><a href="https://aws.amazon.com/sdk-for-go/" target="_blank">AWS SDK for Go</a></p>
                              		
                           </li>
                           <li class="listitem">
                              			
                              <p><a href="https://aws.amazon.com/sdk-for-java/" target="_blank">AWS SDK for Java</a></p>
                              		
                           </li>
                           <li class="listitem">
                              			
                              <p><a href="https://aws.amazon.com/sdk-for-php/" target="_blank">AWS SDK for PHP</a></p>
                              		
                           </li>
                           <li class="listitem">
                              			
                              <p><a href="https://aws.amazon.com/sdk-for-ruby/" target="_blank">AWS SDK for Ruby</a></p>
                              		
                           </li>
                        </ul>
                     </div>
                     		
                     <h2 id="client-side-encryption-kms-managed-master-key-intro">Option
                        				1: Using an AWS KMS&#x2013;Managed Customer Master Key
                        				(CMK)
                     </h2>
                     		
                     <p>When
                        			using an AWS KMS-managed customer master key to enable client-side data
                        			encryption, you provide an AWS KMS customer master key ID (CMK ID). 
                     </p>
                     		
                     <div class="itemizedlist">
                        			
                        			
                        		
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              				
                              <p><span class="topcom">When uploading an object</span>&#x2014;Using the CMK ID, the
                                 					client first sends a request to the AWS Key Management Service (AWS KMS) for
                                 a key that it can use
                                 					to encrypt your object data. AWS KMS returns two versions of a randomly generated
                                 					data encryption key:
                              </p>
                              				
                              <div class="itemizedlist">
                                 					
                                 					
                                 				
                                 <ul class="itemizedlist" type="disc">
                                    <li class="listitem">
                                       						
                                       <p>A plain-text version that the client uses to encrypt the object
                                          							data
                                       </p>
                                       					
                                    </li>
                                    <li class="listitem">
                                       						
                                       <p>A cipher blob of the same data encryption key that the client uploads
                                          							to Amazon S3 as object metadata
                                       </p>
                                       					
                                    </li>
                                 </ul>
                              </div>
                              				
                              <div class="aws-note">
                                 <p class="aws-note">Note</p>
                                 <p>The client obtains a unique data encryption key for each object that it uploads.</p>
                              </div>
                              			
                           </li>
                           <li class="listitem">
                              				
                              <p>
                                 					<span class="topcom">When downloading an object</span>&#x2014;The client
                                 					downloads the encrypted object from Amazon S3 along with the cipher blob version
                                 of
                                 					the data encryption key stored as object metadata. The client then sends the
                                 					cipher blob to AWS KMS to get the plain-text version of the
                                 					key
                                 					so that it can decrypt the object data.
                              </p>
                              			
                           </li>
                        </ul>
                     </div>
                     		
                     <p>For more information about AWS KMS, see <a href="./kms/latest/developerguide/overview.html" target="_blank">What is the
                           				AWS Key Management Service?</a> in the <em>AWS Key Management Service Developer Guide</em>.
                     </p>
                     		
                     <div class="example">
                        <div class="example-contents">
                           <p>The following example uploads an object to Amazon S3 using AWS KMS with the AWS SDK
                              for Java.
                              				The example uses a KMS-managed customer master key (CMK) to encrypt data on the
                              				client side before uploading it to Amazon S3. If you already have a CMK, you can
                              use that
                              				by specifying the value of the <code class="code">kms_cmk_id</code> variable in the sample code.
                              				If you don&apos;t have a CMK, or you need another one, you can generate one through
                              the
                              				Java API. The example shows how to generate a CMK.
                           </p>
                           <p>For more information on key material, see <a href="./kms/latest/developerguide/importing-keys.html" target="_blank">Importing Key Material in AWS Key Management Service
                                 					(AWS KMS)</a>. For instructions on creating and testing a working sample, see
                              					<a href="UsingTheMPJavaAPI.html#TestingJavaSamples">Testing the Amazon S3 Java Code Examples</a>.
                           </p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="">import java.io.ByteArrayOutputStream;
import java.io.IOException;

import com.amazonaws.AmazonServiceException;
import com.amazonaws.SdkClientException;
import com.amazonaws.auth.profile.ProfileCredentialsProvider;
import com.amazonaws.regions.RegionUtils;
import com.amazonaws.services.kms.AWSKMS;
import com.amazonaws.services.kms.AWSKMSClientBuilder;
import com.amazonaws.services.kms.model.CreateKeyResult;
import com.amazonaws.services.s3.AmazonS3Encryption;
import com.amazonaws.services.s3.AmazonS3EncryptionClientBuilder;
import com.amazonaws.services.s3.model.CryptoConfiguration;
import com.amazonaws.services.s3.model.KMSEncryptionMaterialsProvider;
import com.amazonaws.services.s3.model.S3Object;
import com.amazonaws.services.s3.model.S3ObjectInputStream;

public class UploadObjectKMSKey {

    public static void main(String[] args) throws IOException {
        String bucketName = &quot;*** Bucket name ***&quot;;
        String keyName = &quot;*** Object key name ***&quot;;
        String clientRegion = &quot;*** Client region ***&quot;;
        String kms_cmk_id = &quot;***AWS KMS customer master key ID***&quot;;
        int readChunkSize = 4096;

        try {
            // Optional: If you don&apos;t have a KMS key (or need another one),
            // create one. This example creates a key with AWS-created
            // key material.
            AWSKMS kmsClient = AWSKMSClientBuilder.standard()
                                    .withCredentials(new ProfileCredentialsProvider())
                                    .withRegion(clientRegion)
                                    .build();
            CreateKeyResult keyResult = kmsClient.createKey();
            kms_cmk_id = keyResult.getKeyMetadata().getKeyId();
    
             // Create the encryption client.
            KMSEncryptionMaterialsProvider materialProvider = new KMSEncryptionMaterialsProvider(kms_cmk_id);
            CryptoConfiguration cryptoConfig = new CryptoConfiguration()
                    .withAwsKmsRegion(RegionUtils.getRegion(clientRegion));
            AmazonS3Encryption encryptionClient = AmazonS3EncryptionClientBuilder.standard()
                    .withCredentials(new ProfileCredentialsProvider())
                    .withEncryptionMaterials(materialProvider)
                    .withCryptoConfiguration(cryptoConfig)
                    .withRegion(clientRegion).build();
    
            // Upload an object using the encryption client.
            String origContent = &quot;S3 Encrypted Object Using KMS-Managed Customer Master Key.&quot;;
            int origContentLength = origContent.length();
            encryptionClient.putObject(bucketName, keyName, origContent);
    
            // Download the object. The downloaded object is still encrypted.
            S3Object downloadedObject = encryptionClient.getObject(bucketName, keyName);
            S3ObjectInputStream input = downloadedObject.getObjectContent();
    
            // Decrypt and read the object and close the input stream.
            byte[] readBuffer = new byte[readChunkSize];
            ByteArrayOutputStream baos = new ByteArrayOutputStream(readChunkSize);
            int bytesRead = 0;
            int decryptedContentLength = 0;
    
            while ((bytesRead = input.read(readBuffer)) != -1) {
                baos.write(readBuffer, 0, bytesRead);
                decryptedContentLength += bytesRead;
            }
            input.close();
    
            // Verify that the original and decrypted contents are the same size.
            System.out.println(&quot;Original content length: &quot; + origContentLength);
            System.out.println(&quot;Decrypted content length: &quot; + decryptedContentLength);
        }
        catch(AmazonServiceException e) {
            // The call was transmitted successfully, but Amazon S3 couldn&apos;t process 
            // it, so it returned an error response.
            e.printStackTrace();
        }
        catch(SdkClientException e) {
            // Amazon S3 couldn&apos;t be contacted for a response, or the client
            // couldn&apos;t parse the response from Amazon S3.
            e.printStackTrace();
        }
    }
}</code></pre></div>
                     </div>
                     	
                     		
                     <h2 id="client-side-encryption-client-side-master-key-intro">Option 2: Using a
                        				Client-Side Master Key
                     </h2>
                     		
                     <p>This
                        			section shows how to use a
                        			client-side
                        			master key for client-side data encryption. 
                     </p>
                     		
                     <div class="aws-note">
                        <p class="aws-note">Important</p>
                        <p>Your client-side master keys and your unencrypted data are never sent to AWS. It&apos;s
                           				important that you safely manage your encryption keys. If you lose them, you won&apos;t
                           				be able to decrypt your data.
                        </p>
                     </div>
                     		
                     <p>This is how it works:</p>
                     		
                     <div class="itemizedlist">
                        			
                        			
                        		
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              				
                              <p><span class="topcom">When uploading an object</span>&#x2014;You provide a client-side
                                 					master key to the Amazon S3 encryption client. The client uses the master key
                                 only to
                                 					encrypt the data encryption key that it generates randomly. The process works
                                 					like this:
                              </p>
                              				
                              <div class="orderedlist">
                                 					
                                 					
                                 					
                                 				
                                 <ol>
                                    <li>
                                       						
                                       <p>The Amazon S3 encryption client generates a one-time-use symmetric key (also known
                                          as a data
                                          							encryption key or data key) locally. It uses the data key to encrypt the
                                          							data of a single Amazon S3 object. The client generates a separate data key
                                          							for each object.
                                       </p>
                                       					
                                    </li>
                                    <li>
                                       						
                                       <p>The client encrypts the data encryption key using the master key that you provide.
                                          The
                                          							client uploads the encrypted data key and its
                                          							material
                                          							description as part of the object metadata. The
                                          							client uses the material description to determine which client-side
                                          							master key to use for decryption.
                                       </p>
                                       					
                                    </li>
                                    <li>
                                       						
                                       <p>The client uploads the encrypted data to Amazon S3 and saves the encrypted
                                          							data key as object metadata (<code class="code">x-amz-meta-x-amz-key</code>) in
                                          							Amazon S3.
                                       </p>
                                       					
                                    </li>
                                 </ol>
                              </div>
                              			
                           </li>
                           <li class="listitem">
                              				
                              <p><span class="topcom">When downloading an object</span>&#x2014;The client downloads the
                                 					encrypted object from Amazon S3. Using the material description from the object&apos;s
                                 					metadata, the client determines which master key to use to decrypt the data key.
                                 					The client uses that master key to decrypt the data key and then uses the data
                                 					key to decrypt the object. 
                              </p>
                              			
                           </li>
                        </ul>
                     </div>
                     		
                     <p>The
                        			client-side master key that you provide can be either a
                        			symmetric
                        			key or a public/private key pair. The following examples show how to
                        			use both types of keys.
                     </p>
                     		
                     <p>For more information, see <a href="https://aws.amazon.com/articles/2850096021478074" target="_blank"> Client-Side
                           				Data Encryption with the AWS SDK for Java and Amazon S3 </a>.
                     </p>
                     		
                     <div class="aws-note">
                        <p class="aws-note">Note</p>
                        <p>If you get a cipher-encryption error message when you use the encryption API for
                           				the first time, your version of the JDK may have a Java Cryptography Extension
                           (JCE)
                           				jurisdiction policy file that limits the maximum key length for encryption and
                           				decryption transformations to 128 bits. The AWS SDK requires a maximum key length
                           of
                           				256 bits. To check your maximum key length, use the
                           					<code class="code">getMaxAllowedKeyLength()</code> method of the
                           					<code class="code">javax.crypto.Cipher</code> class. To remove the key-length restriction,
                           				install the&#xA0;Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction
                           Policy
                           				Files at the <a href="http://docs.oracle.com/javase/8/" target="_blank">Java SE download
                              					page</a>.
                        </p>
                     </div>
                     		
                     <div class="example">
                        <div class="example-contents">
                           <p>The
                              				following example shows how to do these tasks:
                           </p>
                           <div class="itemizedlist">
                              				
                              				
                              				
                              				
                              				
                              			
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    					
                                    <p>Generate a 256-bit
                                       						AES
                                       						key
                                    </p>
                                    				
                                 </li>
                                 <li class="listitem">
                                    					
                                    <p>Save and load the AES key to and from the file system</p>
                                    				
                                 </li>
                                 <li class="listitem">
                                    					
                                    <p>Use the AES key to encrypt data on the client side before sending it to
                                       						Amazon S3
                                    </p>
                                    				
                                 </li>
                                 <li class="listitem">
                                    					
                                    <p>Use the AES key to decrypt data received from Amazon S3</p>
                                    				
                                 </li>
                                 <li class="listitem">
                                    					
                                    <p>Verify that the decrypted data is the same as the original data</p>
                                    				
                                 </li>
                              </ul>
                           </div>
                           <p>For instructions on creating and testing a working sample, see <a href="UsingTheMPJavaAPI.html#TestingJavaSamples">Testing the Amazon S3 Java Code Examples</a>.
                           </p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="java ">import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.spec.InvalidKeySpecException;
import java.security.spec.X509EncodedKeySpec;

import javax.crypto.KeyGenerator;
import javax.crypto.SecretKey;
import javax.crypto.spec.SecretKeySpec;

import com.amazonaws.AmazonServiceException;
import com.amazonaws.SdkClientException;
import com.amazonaws.auth.profile.ProfileCredentialsProvider;
import com.amazonaws.services.s3.AmazonS3;
import com.amazonaws.services.s3.AmazonS3EncryptionClientBuilder;
import com.amazonaws.services.s3.model.EncryptionMaterials;
import com.amazonaws.services.s3.model.ObjectMetadata;
import com.amazonaws.services.s3.model.PutObjectRequest;
import com.amazonaws.services.s3.model.S3Object;
import com.amazonaws.services.s3.model.StaticEncryptionMaterialsProvider;

public class S3ClientSideEncryptionSymMasterKey {

    public static void main(String[] args) throws Exception {
        String clientRegion = &quot;*** Client region ***&quot;;
        String bucketName = &quot;*** Bucket name ***&quot;;
        String objectKeyName = &quot;*** Object key name ***&quot;;
        String masterKeyDir = System.getProperty(&quot;java.io.tmpdir&quot;);
        String masterKeyName = &quot;secret.key&quot;;

        // Generate a symmetric 256-bit AES key.
        KeyGenerator symKeyGenerator = KeyGenerator.getInstance(&quot;AES&quot;);
        symKeyGenerator.init(256);
        SecretKey symKey = symKeyGenerator.generateKey();

        // To see how it works, save and load the key to and from the file system.
        saveSymmetricKey(masterKeyDir, masterKeyName, symKey);
        symKey = loadSymmetricAESKey(masterKeyDir, masterKeyName, &quot;AES&quot;);

        try {
            // Create the Amazon S3 encryption client.
            EncryptionMaterials encryptionMaterials = new EncryptionMaterials(symKey);
            AmazonS3 s3EncryptionClient = AmazonS3EncryptionClientBuilder.standard()
                    .withCredentials(new ProfileCredentialsProvider())
                    .withEncryptionMaterials(new StaticEncryptionMaterialsProvider(encryptionMaterials))
                    .withRegion(clientRegion)
                    .build();

            // Upload a new object. The encryption client automatically encrypts it.
            byte[] plaintext = &quot;S3 Object Encrypted Using Client-Side Symmetric Master Key.&quot;.getBytes();
            s3EncryptionClient.putObject(new PutObjectRequest(bucketName, 
                                                            objectKeyName, 
                                                            new ByteArrayInputStream(plaintext), 
                                                            new ObjectMetadata()));
    
            // Download and decrypt the object.
            S3Object downloadedObject = s3EncryptionClient.getObject(bucketName, objectKeyName);
            byte[] decrypted = com.amazonaws.util.IOUtils.toByteArray(downloadedObject.getObjectContent());
    
            // Verify that the data that you downloaded is the same as the original data.
            System.out.println(&quot;Plaintext: &quot; + new String(plaintext));
            System.out.println(&quot;Decrypted text: &quot; + new String(decrypted));
        }
        catch(AmazonServiceException e) {
            // The call was transmitted successfully, but Amazon S3 couldn&apos;t process 
            // it, so it returned an error response.
            e.printStackTrace();
        }
        catch(SdkClientException e) {
            // Amazon S3 couldn&apos;t be contacted for a response, or the client
            // couldn&apos;t parse the response from Amazon S3.
            e.printStackTrace();
        }
    }

    private static void saveSymmetricKey(String masterKeyDir, String masterKeyName, SecretKey secretKey) throws IOException {
        X509EncodedKeySpec x509EncodedKeySpec = new X509EncodedKeySpec(secretKey.getEncoded());
        FileOutputStream keyOutputStream = new FileOutputStream(masterKeyDir + File.separator + masterKeyName);
        keyOutputStream.write(x509EncodedKeySpec.getEncoded());
        keyOutputStream.close();
    }

    private static SecretKey loadSymmetricAESKey(String masterKeyDir, String masterKeyName, String algorithm)
            throws IOException, NoSuchAlgorithmException, InvalidKeySpecException, InvalidKeyException {
        // Read the key from the specified file.
        File keyFile = new File(masterKeyDir + File.separator + masterKeyName);
        FileInputStream keyInputStream = new FileInputStream(keyFile);
        byte[] encodedPrivateKey = new byte[(int) keyFile.length()];
        keyInputStream.read(encodedPrivateKey);
        keyInputStream.close();

        // Reconstruct and return the master key.
        return new SecretKeySpec(encodedPrivateKey, &quot;AES&quot;);
    }
}</code></pre></div>
                     </div>
                     		
                     <p>The following example shows how to do these tasks:</p>
                     		
                     <div class="itemizedlist">
                        			
                        			
                        			
                        			
                        			
                        		
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              				
                              <p>Generate a 1024-bit
                                 					RSA
                                 					key pair
                              </p>
                              			
                           </li>
                           <li class="listitem">
                              				
                              <p>Save and load the RSA keys to and from the file system</p>
                              			
                           </li>
                           <li class="listitem">
                              				
                              <p>Use the RSA keys to encrypt data on the client side before sending it to
                                 					Amazon S3
                              </p>
                              			
                           </li>
                           <li class="listitem">
                              				
                              <p>Use the RSA keys to decrypt data received from Amazon S3</p>
                              			
                           </li>
                           <li class="listitem">
                              				
                              <p>Verify that the decrypted data is the same as the original data</p>
                              			
                           </li>
                        </ul>
                     </div>
                     		
                     <p>For instructions on creating and testing a working sample, see <a href="UsingTheMPJavaAPI.html#TestingJavaSamples">Testing the Amazon S3 Java Code Examples</a>.
                     </p>
                     		<pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="java ">import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.security.KeyFactory;
import java.security.KeyPair;
import java.security.KeyPairGenerator;
import java.security.NoSuchAlgorithmException;
import java.security.PrivateKey;
import java.security.PublicKey;
import java.security.SecureRandom;
import java.security.spec.InvalidKeySpecException;
import java.security.spec.PKCS8EncodedKeySpec;
import java.security.spec.X509EncodedKeySpec;

import com.amazonaws.AmazonServiceException;
import com.amazonaws.SdkClientException;
import com.amazonaws.auth.profile.ProfileCredentialsProvider;
import com.amazonaws.services.s3.AmazonS3;
import com.amazonaws.services.s3.AmazonS3EncryptionClientBuilder;
import com.amazonaws.services.s3.model.EncryptionMaterials;
import com.amazonaws.services.s3.model.ObjectMetadata;
import com.amazonaws.services.s3.model.PutObjectRequest;
import com.amazonaws.services.s3.model.S3Object;
import com.amazonaws.services.s3.model.StaticEncryptionMaterialsProvider;
import com.amazonaws.util.IOUtils;

public class S3ClientSideEncryptionAsymmetricMasterKey {

    public static void main(String[] args) throws Exception {
        String clientRegion = &quot;*** Client region ***&quot;;
        String bucketName = &quot;*** Bucket name ***&quot;;
        String objectKeyName = &quot;*** Key name ***&quot;;
        String rsaKeyDir = System.getProperty(&quot;java.io.tmpdir&quot;);
        String publicKeyName = &quot;public.key&quot;;
        String privateKeyName = &quot;private.key&quot;;

        // Generate a 1024-bit RSA key pair.
        KeyPairGenerator keyGenerator = KeyPairGenerator.getInstance(&quot;RSA&quot;);
        keyGenerator.initialize(1024, new SecureRandom());
        KeyPair origKeyPair = keyGenerator.generateKeyPair();

        // To see how it works, save and load the key pair to and from the file system.
        saveKeyPair(rsaKeyDir, publicKeyName, privateKeyName, origKeyPair);
        KeyPair keyPair = loadKeyPair(rsaKeyDir, publicKeyName, privateKeyName, &quot;RSA&quot;);

        try {
            // Create the encryption client.
            EncryptionMaterials encryptionMaterials = new EncryptionMaterials(keyPair);
            AmazonS3 s3EncryptionClient = AmazonS3EncryptionClientBuilder.standard()
                    .withCredentials(new ProfileCredentialsProvider())
                    .withEncryptionMaterials(new StaticEncryptionMaterialsProvider(encryptionMaterials))
                    .withRegion(clientRegion)
                    .build();
    
            // Create a new object.
            byte[] plaintext = &quot;S3 Object Encrypted Using Client-Side Asymmetric Master Key.&quot;.getBytes();
            S3Object object = new S3Object();
            object.setKey(objectKeyName);
            object.setObjectContent(new ByteArrayInputStream(plaintext));
            ObjectMetadata metadata = new ObjectMetadata();
            metadata.setContentLength(plaintext.length);

            // Upload the object. The encryption client automatically encrypts it.
            PutObjectRequest putRequest = new PutObjectRequest(bucketName, 
                                                               object.getKey(), 
                                                               object.getObjectContent(),
                                                               metadata);
            s3EncryptionClient.putObject(putRequest);
    
            // Download and decrypt the object.
            S3Object downloadedObject = s3EncryptionClient.getObject(bucketName, object.getKey());
            byte[] decrypted = IOUtils.toByteArray(downloadedObject.getObjectContent());
    
            // Verify that the data that you downloaded is the same as the original data.
            System.out.println(&quot;Plaintext: &quot; + new String(plaintext));
            System.out.println(&quot;Decrypted text: &quot; + new String(decrypted));
        }
        catch(AmazonServiceException e) {
            // The call was transmitted successfully, but Amazon S3 couldn&apos;t process 
            // it, so it returned an error response.
            e.printStackTrace();
        }
        catch(SdkClientException e) {
            // Amazon S3 couldn&apos;t be contacted for a response, or the client
            // couldn&apos;t parse the response from Amazon S3.
            e.printStackTrace();
        }
    }

    private static void saveKeyPair(String dir, 
                                   String publicKeyName, 
                                   String privateKeyName, 
                                   KeyPair keyPair) throws IOException {
        PrivateKey privateKey = keyPair.getPrivate();
        PublicKey publicKey = keyPair.getPublic();

        // Write the public key to the specified file.
        X509EncodedKeySpec x509EncodedKeySpec = new X509EncodedKeySpec(publicKey.getEncoded());
        FileOutputStream publicKeyOutputStream = new FileOutputStream(dir + File.separator + publicKeyName);
        publicKeyOutputStream.write(x509EncodedKeySpec.getEncoded());
        publicKeyOutputStream.close();

        // Write the private key to the specified file.
        PKCS8EncodedKeySpec pkcs8EncodedKeySpec = new PKCS8EncodedKeySpec(privateKey.getEncoded());
        FileOutputStream privateKeyOutputStream = new FileOutputStream(dir + File.separator + privateKeyName);
        privateKeyOutputStream.write(pkcs8EncodedKeySpec.getEncoded());
        privateKeyOutputStream.close();
    }

    private static KeyPair loadKeyPair(String dir,
                                      String publicKeyName,
                                      String privateKeyName,
                                      String algorithm)
            throws IOException, NoSuchAlgorithmException, InvalidKeySpecException {
        // Read the public key from the specified file.
        File publicKeyFile = new File(dir + File.separator + publicKeyName);
        FileInputStream publicKeyInputStream = new FileInputStream(publicKeyFile);
        byte[] encodedPublicKey = new byte[(int) publicKeyFile.length()];
        publicKeyInputStream.read(encodedPublicKey);
        publicKeyInputStream.close();

        // Read the private key from the specified file.
        File privateKeyFile = new File(dir + File.separator + privateKeyName);
        FileInputStream privateKeyInputStream = new FileInputStream(privateKeyFile);
        byte[] encodedPrivateKey = new byte[(int) privateKeyFile.length()];
        privateKeyInputStream.read(encodedPrivateKey);
        privateKeyInputStream.close();

        // Convert the keys into a key pair.
        KeyFactory keyFactory = KeyFactory.getInstance(algorithm);
        X509EncodedKeySpec publicKeySpec = new X509EncodedKeySpec(encodedPublicKey);
        PublicKey publicKey = keyFactory.generatePublic(publicKeySpec);

        PKCS8EncodedKeySpec privateKeySpec = new PKCS8EncodedKeySpec(encodedPrivateKey);
        PrivateKey privateKey = keyFactory.generatePrivate(privateKeySpec);

        return new KeyPair(publicKey, privateKey);
    }
}
</code></pre>
                     	</div>
                  <noscript>
                     <div>
                        <div>
                           <div>
                              <div id="js_error_message">
                                 <p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p>
                                 <p>To use the AWS Documentation, Javascript must be enabled. Please refer to your browser's
                                    Help pages for instructions.
                                 </p>
                              </div>
                           </div>
                        </div>
                     </div>
                  </noscript>
                  <div id="main-col-footer">
                     <div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div>
                     <div id="next"><a class="awstoc" accesskey="p" href="ServerSideEncryptionCustomerKeysSSEUsingRESTAPI.html">&#xAB; Previous </a><a class="awstoc" accesskey="n" href="Versioning.html">Next &#xBB;</a></div>
                     <div id="copyright-main-footer">&#xA9; 2018, Amazon Web Services, Inc. or its affiliates. All rights reserved.</div>
                  </div>
               </div>
            </div>
            <div id="right-expanded">
               <div id="right-content-wrapper">
                  <div id="pagetoc">
                     <p>On this page:</p>
                     <ul class="pagetoc">
                        <li class="pagetoc" name="Option
				1: Using an AWS KMS&#x2013;Managed Customer Master Key
				(CMK)"><a class="pagetoc" href="#client-side-encryption-kms-managed-master-key-intro">Option
                              				1: Using an AWS KMS&#x2013;Managed Customer Master Key
                              				(CMK)</a></li>
                        <li class="pagetoc" name="Option 2: Using a
				Client-Side Master Key"><a class="pagetoc" href="#client-side-encryption-client-side-master-key-intro">Option 2: Using a
                              				Client-Side Master Key</a></li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      </div>
      
      <!-- SiteCatalyst code version: H.25.2.
            Copyright 1996-2012 Adobe, Inc. All Rights Reserved
            More info available at http://www.omniture.com --><script language="JavaScript" type="text/javascript" src="https://a0.awsstatic.com/s_code/js/1.0/awshome_s_code.js"></script><script language="JavaScript" type="text/javascript">
         <!--

            // Documentation Service Name
            s.prop66='Amazon Simple Storage Service';
            s.eVar66='D=c66';
  
            // Documentation Guide Name                                                                 
            s.prop65='Developer Guide';
            s.eVar65='D=c65';

            var s_code=s.t();if(s_code)document.write(s_code)//--></script><script language="JavaScript" type="text/javascript">
         <!--
                if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
                //--></script><noscript><img src="https://amazonwebservices.d2.sc.omtrdc.net/b/ss/awsamazondev/1/H.25.2--NS/0" height="1" width="1" border="0" alt="" /></noscript>
      <!--/DO NOT REMOVE/-->
      <!-- End SiteCatalyst code version: H.25.2. -->
   
</body></html>