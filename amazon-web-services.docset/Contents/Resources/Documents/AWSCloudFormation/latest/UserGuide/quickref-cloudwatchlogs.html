<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Amazon CloudWatch Logs Template Snippets - AWS CloudFormation</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="home" href="#top">
      <link rel="up" href="CHAP_TemplateQuickRef.html" title="Template Snippets">
      <link rel="prev" href="quickref-cloudwatch.html" title="Amazon CloudWatch Template Snippets">
      <link rel="next" href="quickref-dynamodb.html" title="Amazon DynamoDB Template Snippets">
      <meta name="description" content="Use Amazon CloudWatch Logs template snippets to help you describe CloudWatch Logs resources in your AWS CloudFormation templates.">
      <meta name="keywords" content="CloudFormation,AWSCloudFormation,resource provisioning,resource configuration,infrastructure management,CloudFormer,CloudFormation Designer,CloudFormation stack,CloudFormation stackset,CloudFormation template,change set">
      <meta name="deployment_region" content="IAD">
      <meta name="product" content="AWS CloudFormation">
      <meta name="guide" content="User Guide">
      <meta name="guide-locale" content="en_us">
      <link rel="icon" type="image/ico" href="/images/favicon.ico">
      <link rel="shortcut icon" type="image/ico" href="/images/favicon.ico">
      <link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/quickref-cloudwatchlogs.html">
      <link rel="stylesheet" type="text/css" href="../../../css/jquery-ui.min.css">
      <link rel="stylesheet" type="text/css" href="../../../css/font-awesome.min.css">
      <link rel="stylesheet" type="text/css" href="../../../css/google-font.css">
      <link id="code-style" rel="stylesheet" type="text/css" href="../../../css/light.css">
      <link rel="stylesheet" type="text/css" href="../../../css/jquery-ui.theme.css">
      <link rel="stylesheet" type="text/css" href="../../../css/colorbox.css">
      <link rel="stylesheet" type="text/css" href="../../../css/awsdocs.css"><script type="text/javascript" src="/js/highlight.pack.js"></script><script type="text/javascript" src="/js/jquery.min.js"></script><script type="text/javascript" src="/js/jquery-ui.min.js"></script><script type="text/javascript" src="/js/handlebars.js"></script><script type="text/javascript" src="/js/jquery.colorbox.js"></script><script type="text/javascript" src="/js/awsdocs.min.js?v=20170615"></script></head>
   <body id="top">
      
      <div id="content-container">
         
         <div id="main-column">
            <div id="main">
               <div id="main-content">
                  <div id="main-col-body">
                     <table summary="Breadcrumbs">
                        <tbody><tr>
                           <td>
                              <div class="breadcrumb"><a href="http://aws.amazon.com/documentation">AWS Documentation</a> &#xBB; <a href="http://aws.amazon.com/documentation/cloudformation">AWS CloudFormation</a> &#xBB; <a href="index.html">User Guide</a> &#xBB; <a href="template-guide.html">Working with AWS CloudFormation Templates</a> &#xBB; <a href="CHAP_TemplateQuickRef.html">Template Snippets</a> &#xBB; <span class="breadcrumb">Amazon CloudWatch Logs Template Snippets</span></div>
                           </td>
                        </tr>
                     </tbody></table>
                     <div></div>
                     <div id="language-filter" class="page-header" style="display:none">
                        <form> Filter View: 
                           <select name="filter-select" id="filter-select">
                              <option selected="1">All</option>
                              <option value="JSON" selected>JSON</option>
                              <option value="YAML" selected>YAML</option></select></form>
                     </div>
                     <h1 class="topictitle" id="quickref-cloudwatchlogs">Amazon CloudWatch Logs Template Snippets</h1>
                     <p>Amazon CloudWatch Logs can monitor your system, application, and custom log files
                        from Amazon EC2
                        instances or other sources. You can use AWS CloudFormation to provision and manage
                        log groups and
                        metric filters. For more information about getting started with Amazon CloudWatch
                        Logs, see <a href="./AmazonCloudWatch/latest/DeveloperGuide/WhatIsCloudWatchLogs.html" target="_blank">Monitoring System, Application, and
                           Custom Log Files </a> in the <em>Amazon CloudWatch User Guide</em>.
                     </p>
                     <div class="highlights" id="inline-topiclist">
                        <p><strong>Topics</strong></p>
                        <ul>
                           <li><a href="#quickref-cloudwatchlogs-example1">Send Logs to CloudWatch Logs from a Linux Instance</a></li>
                           <li><a href="#quickref-cloudwatchlogs-example2">Send Logs to CloudWatch Logs from a Windows Instance</a></li>
                           <li><a href="#w2ab2c17c24c31c11">See Also</a></li>
                        </ul>
                     </div>
                     <h2 id="quickref-cloudwatchlogs-example1">Send Logs to CloudWatch Logs from a Linux Instance</h2>
                     
                     
                     <p>The following template describes a web server and its custom metrics. Log events from
                        the web server&apos;s log provides the data for the custom metrics. To send log events
                        to a
                        custom metric, the <code class="code">UserData</code> field installs a CloudWatch Logs agent on the Amazon EC2
                        instance. The configuration information for the agent, such as the location of the
                        server log file, the log group name, and the log stream name, are defined in the
                        <code>/tmp/cwlogs/apacheaccess.conf</code> file. The log stream is created
                        after the web server starts sending log events to the
                        <code>/var/log/httpd/access_log</code> file.
                     </p>       
                     
                     <div class="aws-note">
                        <p class="aws-note">Note</p>
                        <p>A note about permissions: The <code class="code">WebServerHost</code> instance references the <code class="code">LogRoleInstanceProfile</code> instance profile, 
                           which in turn references the <code class="code">LogRole</code> role. <code class="code">LogRole</code> specifies the <code class="code">s3:GetObject</code> permission for <em>arn:aws:s3:::*</em>.
                        </p>
                        <p>This permission is required because <code class="code">WebServerHost</code> downloads the CloudWatch Logs agent (<code>awslogs-agent-setup.py</code>) from Amazon S3 in the <code class="code">UserData</code> section.
                        </p>
                     </div>
                     
                     <p>The two metric filters describe how the log information is transformed into CloudWatch
                        metrics. The 404 metric counts the number of 404 occurrences. The size metric tracks
                        the
                        size of a request. The two CloudWatch alarms will send notifications if there are
                        more than
                        two 404s within two minutes or if the average request size is over 3500 KB over 10
                        minutes.
                     </p>
                     
                     <div id="JSON" name="JSON" class="section langfilter">
                        <h3 id="quickref-cloudwatchlogs-example.json">JSON</h3>
                        
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight ">{
    &quot;AWSTemplateFormatVersion&quot;: &quot;2010-09-09&quot;,
    &quot;Description&quot;: &quot;AWS CloudFormation Sample Template for CloudWatch Logs.&quot;,
    &quot;Parameters&quot;: {
        &quot;KeyName&quot;: {
          &quot;Description&quot;: &quot;Name of an existing EC2 KeyPair to enable SSH access to the instances&quot;,
          &quot;Type&quot;: &quot;AWS::EC2::KeyPair::KeyName&quot;,
          &quot;ConstraintDescription&quot; : &quot;must be the name of an existing EC2 KeyPair.&quot;
        },
        &quot;SSHLocation&quot; : {
          &quot;Description&quot; : &quot;The IP address range that can be used to SSH to the EC2 instances&quot;,
          &quot;Type&quot;: &quot;String&quot;,
          &quot;MinLength&quot;: &quot;9&quot;,
          &quot;MaxLength&quot;: &quot;18&quot;,
          &quot;Default&quot;: &quot;0.0.0.0/0&quot;,
          &quot;AllowedPattern&quot;: &quot;(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})&quot;,
          &quot;ConstraintDescription&quot;: &quot;must be a valid IP CIDR range of the form x.x.x.x/x.&quot;
       },
       &quot;OperatorEmail&quot;: {
          &quot;Description&quot;: &quot;Email address to notify if there are any scaling operations&quot;,
          &quot;Type&quot;: &quot;String&quot;
       }
    },
    &quot;Mappings&quot;: {
        &quot;RegionMap&quot;: {
            &quot;us-east-1&quot;: {
                &quot;AMI&quot;: &quot;ami-fb8e9292&quot;
            },
            &quot;us-west-1&quot;: {
                &quot;AMI&quot;: &quot;ami-7aba833f&quot;
            },
            &quot;us-west-2&quot;: {
                &quot;AMI&quot;: &quot;ami-043a5034&quot;
            },
            &quot;eu-west-1&quot;: {
                &quot;AMI&quot;: &quot;ami-2918e35e&quot;
            },
            &quot;ap-southeast-1&quot;: {
                &quot;AMI&quot;: &quot;ami-b40d5ee6&quot;
            },
            &quot;ap-southeast-2&quot;: {
                &quot;AMI&quot;: &quot;ami-3b4bd301&quot;
            },
            &quot;ap-northeast-1&quot;: {
                &quot;AMI&quot;: &quot;ami-c9562fc8&quot;
            },
            &quot;sa-east-1&quot;: {
                &quot;AMI&quot;: &quot;ami-215dff3c&quot;
            },
            &quot;eu-central-1&quot;: {
                &quot;AMI&quot; : &quot;ami-a03503bd&quot;
            }
        }
    },
    &quot;Resources&quot;: {
        &quot;LogRole&quot;: {
            &quot;Type&quot;: &quot;AWS::IAM::Role&quot;,
            &quot;Properties&quot;: {
                &quot;AssumeRolePolicyDocument&quot;: {
                    &quot;Version&quot;: &quot;2012-10-17&quot;,
                    &quot;Statement&quot;: [
                        {
                            &quot;Effect&quot;: &quot;Allow&quot;,
                            &quot;Principal&quot;: {
                                &quot;Service&quot;: [
                                    &quot;ec2.amazonaws.com&quot;
                                ]
                            },
                            &quot;Action&quot;: [
                                &quot;sts:AssumeRole&quot;
                            ]
                        }
                    ]
                },
                &quot;Path&quot;: &quot;/&quot;,
                &quot;Policies&quot;: [
                    {
                        &quot;PolicyName&quot;: &quot;LogRolePolicy&quot;,
                        &quot;PolicyDocument&quot;: {
                            &quot;Version&quot;: &quot;2012-10-17&quot;,
                            &quot;Statement&quot;: [
                                {
                                    &quot;Effect&quot;: &quot;Allow&quot;,
                                    &quot;Action&quot;: [
                                      &quot;logs:Create*&quot;,
                                      &quot;logs:PutLogEvents&quot;,
                                      &quot;s3:GetObject&quot;
                                    ],     
                                    &quot;Resource&quot;: [
                                        &quot;arn:aws:logs:*:*:*&quot;,
                                        &quot;arn:aws:s3:::*&quot;
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        &quot;LogRoleInstanceProfile&quot;: {
            &quot;Type&quot;: &quot;AWS::IAM::InstanceProfile&quot;,
            &quot;Properties&quot;: {
                &quot;Path&quot;: &quot;/&quot;,
                &quot;Roles&quot;: [
                    {
                        &quot;Ref&quot;: &quot;LogRole&quot;
                    }
                ]
            }
        },
        &quot;WebServerSecurityGroup&quot;: {
          &quot;Type&quot;: &quot;AWS::EC2::SecurityGroup&quot;,
          &quot;Properties&quot;: {
            &quot;GroupDescription&quot;: &quot;Enable HTTP access via port 80 and SSH access via port 22&quot;,
            &quot;SecurityGroupIngress&quot; : [
              {&quot;IpProtocol&quot; : &quot;tcp&quot;, &quot;FromPort&quot; : &quot;80&quot;, &quot;ToPort&quot; : &quot;80&quot;, &quot;CidrIp&quot; : &quot;0.0.0.0/0&quot;},
              {&quot;IpProtocol&quot; : &quot;tcp&quot;, &quot;FromPort&quot; : &quot;22&quot;, &quot;ToPort&quot; : &quot;22&quot;, &quot;CidrIp&quot; : { &quot;Ref&quot; : &quot;SSHLocation&quot;}}
            ]
          }
        },
        &quot;WebServerHost&quot;: {
            &quot;Type&quot;: &quot;AWS::EC2::Instance&quot;,
            &quot;Metadata&quot;: {
                &quot;Comment&quot;: &quot;Install a simple PHP application&quot;,
                &quot;AWS::CloudFormation::Init&quot;: {
                    &quot;config&quot;: {
                        &quot;packages&quot;: {
                            &quot;yum&quot;: {
                                &quot;httpd&quot;: [],
                                &quot;php&quot;: []
                            }
                        },
                        &quot;files&quot;: {
                            &quot;/tmp/cwlogs/apacheaccess.conf&quot;: {
                                &quot;content&quot;: {
                                    &quot;Fn::Join&quot;: [
                                        &quot;&quot;,
                                        [
                                            &quot;[general]\n&quot;,
                                            &quot;state_file= /var/awslogs/agent-state\n&quot;,
                                            &quot;[/var/log/httpd/access_log]\n&quot;,
                                            &quot;file = /var/log/httpd/access_log\n&quot;,
                                            &quot;log_group_name = &quot;, {&quot;Ref&quot;: &quot;WebServerLogGroup&quot;}, &quot;\n&quot;,
                                            &quot;log_stream_name = {instance_id}/apache.log\n&quot;,
                                            &quot;datetime_format = %d/%b/%Y:%H:%M:%S&quot;
                                        ]
                                    ]
                                },
                                &quot;mode&quot;: &quot;000400&quot;,
                                &quot;owner&quot;: &quot;apache&quot;,
                                &quot;group&quot;: &quot;apache&quot;
                            },
                            &quot;/var/www/html/index.php&quot;: {
                                &quot;content&quot;: {
                                    &quot;Fn::Join&quot;: [
                                        &quot;&quot;,
                                        [
                                            &quot;&lt;?php\n&quot;,
                                            &quot;echo &apos;&lt;h1&gt;AWS CloudFormation sample PHP application&lt;/h1&gt;&apos;;\n&quot;,
                                            &quot;?&gt;\n&quot;
                                        ]
                                    ]
                                },
                                &quot;mode&quot;: &quot;000644&quot;,
                                &quot;owner&quot;: &quot;apache&quot;,
                                &quot;group&quot;: &quot;apache&quot;
                            },
                            &quot;/etc/cfn/cfn-hup.conf&quot;: {
                                &quot;content&quot;: {
                                    &quot;Fn::Join&quot;: [
                                        &quot;&quot;,
                                        [
                                            &quot;[main]\n&quot;,
                                            &quot;stack=&quot;,
                                            {
                                                &quot;Ref&quot;: &quot;AWS::StackId&quot;
                                            },
                                            &quot;\n&quot;,
                                            &quot;region=&quot;,
                                            {
                                                &quot;Ref&quot;: &quot;AWS::Region&quot;
                                            },
                                            &quot;\n&quot;
                                        ]
                                    ]
                                },
                                &quot;mode&quot;: &quot;000400&quot;,
                                &quot;owner&quot;: &quot;root&quot;,
                                &quot;group&quot;: &quot;root&quot;
                            },
                            &quot;/etc/cfn/hooks.d/cfn-auto-reloader.conf&quot;: {
                                &quot;content&quot;: {
                                    &quot;Fn::Join&quot;: [
                                        &quot;&quot;,
                                        [
                                            &quot;[cfn-auto-reloader-hook]\n&quot;,
                                            &quot;triggers=post.update\n&quot;,
                                            &quot;path=Resources.WebServerHost.Metadata.AWS::CloudFormation::Init\n&quot;,
                                            &quot;action=/opt/aws/bin/cfn-init -s &quot;,
                                            {
                                                &quot;Ref&quot;: &quot;AWS::StackId&quot;
                                            },
                                            &quot; -r WebServerHost &quot;,
                                            &quot; --region     &quot;,
                                            {
                                                &quot;Ref&quot;: &quot;AWS::Region&quot;
                                            },
                                            &quot;\n&quot;,
                                            &quot;runas=root\n&quot;
                                        ]
                                    ]
                                }
                            }
                        },
                        &quot;services&quot;: {
                            &quot;sysvinit&quot;: {
                                &quot;httpd&quot;: {
                                    &quot;enabled&quot;: &quot;true&quot;,
                                    &quot;ensureRunning&quot;: &quot;true&quot;
                                },
                                &quot;sendmail&quot;: {
                                    &quot;enabled&quot;: &quot;false&quot;,
                                    &quot;ensureRunning&quot;: &quot;false&quot;
                                }
                            }
                        }
                    }
                }
            },
            &quot;CreationPolicy&quot; : {
                &quot;ResourceSignal&quot; : { &quot;Timeout&quot; : &quot;PT5M&quot; }
            },
            &quot;Properties&quot;: {
                &quot;ImageId&quot;: {
                    &quot;Fn::FindInMap&quot;: [
                        &quot;RegionMap&quot;,
                        {
                            &quot;Ref&quot;: &quot;AWS::Region&quot;
                        },
                        &quot;AMI&quot;
                    ]
                },
                &quot;KeyName&quot;: {
                    &quot;Ref&quot;: &quot;KeyName&quot;
                },
                &quot;InstanceType&quot;: &quot;t1.micro&quot;,
                &quot;SecurityGroups&quot;: [ { &quot;Ref&quot;: &quot;WebServerSecurityGroup&quot; } ],
                &quot;IamInstanceProfile&quot;: { &quot;Ref&quot;: &quot;LogRoleInstanceProfile&quot; },
                &quot;UserData&quot;: {
                    &quot;Fn::Base64&quot;: {
                        &quot;Fn::Join&quot;: [
                            &quot;&quot;,
                            [
                                &quot;#!/bin/bash -xe\n&quot;,
                               
                                &quot;# Get the latest CloudFormation package\n&quot;,
                                &quot;yum install -y aws-cfn-bootstrap\n&quot;,
                                
                                &quot;# Start cfn-init\n&quot;,
                                &quot;/opt/aws/bin/cfn-init -s &quot;, { &quot;Ref&quot;: &quot;AWS::StackId&quot; }, &quot; -r WebServerHost &quot;, &quot; --region &quot;, { &quot;Ref&quot;: &quot;AWS::Region&quot; },
                                &quot; || error_exit &apos;Failed to run cfn-init&apos;\n&quot;,
                                
                                &quot;# Start up the cfn-hup daemon to listen for changes to the EC2 instance metadata\n&quot;,
                                &quot;/opt/aws/bin/cfn-hup || error_exit &apos;Failed to start cfn-hup&apos;\n&quot;,
                                
                                &quot;# Get the CloudWatch Logs agent\n&quot;,
                                &quot;wget https://s3.amazonaws.com/aws-cloudwatch/downloads/latest/awslogs-agent-setup.py\n&quot;,
                                
                                &quot;# Install the CloudWatch Logs agent\n&quot;,
                                &quot;python awslogs-agent-setup.py -n -r &quot;, { &quot;Ref&quot; : &quot;AWS::Region&quot; }, &quot; -c /tmp/cwlogs/apacheaccess.conf || error_exit &apos;Failed to run CloudWatch Logs agent setup&apos;\n&quot;,
                                
                                &quot;# All done so signal success\n&quot;,
                                &quot;/opt/aws/bin/cfn-signal -e $? &quot;,
                                &quot;         --stack &quot;, { &quot;Ref&quot; : &quot;AWS::StackName&quot; },
                                &quot;         --resource WebServerHost &quot;,
                                &quot;         --region &quot;, { &quot;Ref&quot; : &quot;AWS::Region&quot; }, &quot;\n&quot;
                            ]
                        ]
                    }
                }
            }
        },
        &quot;WebServerLogGroup&quot;: {
            &quot;Type&quot;: &quot;AWS::Logs::LogGroup&quot;,
            &quot;Properties&quot;: {
                &quot;RetentionInDays&quot;: 7
            }
        },
        &quot;404MetricFilter&quot;: {
            &quot;Type&quot;: &quot;AWS::Logs::MetricFilter&quot;,
            &quot;Properties&quot;: {
                &quot;LogGroupName&quot;: {
                    &quot;Ref&quot;: &quot;WebServerLogGroup&quot;
                },
                &quot;FilterPattern&quot;: &quot;[ip, identity, user_id, timestamp, request, status_code = 404, size, ...]&quot;,
                &quot;MetricTransformations&quot;: [
                    {
                        &quot;MetricValue&quot;: &quot;1&quot;,
                        &quot;MetricNamespace&quot;: &quot;test/404s&quot;,
                        &quot;MetricName&quot;: &quot;test404Count&quot;
                    }
                ]
            }
        },
        &quot;BytesTransferredMetricFilter&quot;: {
            &quot;Type&quot;: &quot;AWS::Logs::MetricFilter&quot;,
            &quot;Properties&quot;: {
                &quot;LogGroupName&quot;: {
                    &quot;Ref&quot;: &quot;WebServerLogGroup&quot;
                },
                &quot;FilterPattern&quot;: &quot;[ip, identity, user_id, timestamp, request, status_code, size, ...]&quot;,
                &quot;MetricTransformations&quot;: [
                    {
                        &quot;MetricValue&quot;: &quot;$size&quot;,
                        &quot;MetricNamespace&quot;: &quot;test/BytesTransferred&quot;,
                        &quot;MetricName&quot;: &quot;testBytesTransferred&quot;
                    }
                ]
            }
        },
        &quot;404Alarm&quot;: {
            &quot;Type&quot;: &quot;AWS::CloudWatch::Alarm&quot;,
            &quot;Properties&quot;: {
                &quot;AlarmDescription&quot;: &quot;The number of 404s is greater than 2 over 2 minutes&quot;,
                &quot;MetricName&quot;: &quot;test404Count&quot;,
                &quot;Namespace&quot;: &quot;test/404s&quot;,
                &quot;Statistic&quot;: &quot;Sum&quot;,
                &quot;Period&quot;: &quot;60&quot;,
                &quot;EvaluationPeriods&quot;: &quot;2&quot;,
                &quot;Threshold&quot;: &quot;2&quot;,
                &quot;AlarmActions&quot;: [
                    {
                        &quot;Ref&quot;: &quot;AlarmNotificationTopic&quot;
                    }
                ],
                &quot;ComparisonOperator&quot;: &quot;GreaterThanThreshold&quot;
            }
        },
        &quot;BandwidthAlarm&quot;: {
            &quot;Type&quot;: &quot;AWS::CloudWatch::Alarm&quot;,
            &quot;Properties&quot;: {
                &quot;AlarmDescription&quot;: &quot;The average volume of traffic is greater 3500 KB over 10 minutes&quot;,
                &quot;MetricName&quot;: &quot;testBytesTransferred&quot;,
                &quot;Namespace&quot;: &quot;test/BytesTransferred&quot;,
                &quot;Statistic&quot;: &quot;Average&quot;,
                &quot;Period&quot;: &quot;300&quot;,
                &quot;EvaluationPeriods&quot;: &quot;2&quot;,
                &quot;Threshold&quot;: &quot;3500&quot;,
                &quot;AlarmActions&quot;: [
                    {
                        &quot;Ref&quot;: &quot;AlarmNotificationTopic&quot;
                    }
                ],
                &quot;ComparisonOperator&quot;: &quot;GreaterThanThreshold&quot;
            }
        },
        &quot;AlarmNotificationTopic&quot;: {
          &quot;Type&quot;: &quot;AWS::SNS::Topic&quot;,
          &quot;Properties&quot;: {
            &quot;Subscription&quot;: [
                {
                    &quot;Endpoint&quot;: { &quot;Ref&quot;: &quot;OperatorEmail&quot; },
                    &quot;Protocol&quot;: &quot;email&quot;
                }
             ]
          }
        }
    },
    &quot;Outputs&quot;: {
        &quot;InstanceId&quot;: {
            &quot;Description&quot;: &quot;The instance ID of the web server&quot;,
            &quot;Value&quot;: {
                &quot;Ref&quot;: &quot;WebServerHost&quot;
            }
        },
        &quot;WebsiteURL&quot; : {
          &quot;Value&quot; : { &quot;Fn::Join&quot; : [&quot;&quot;, [&quot;http://&quot;, { &quot;Fn::GetAtt&quot; : [ &quot;WebServerHost&quot;, &quot;PublicDnsName&quot; ]}]] },
          &quot;Description&quot; : &quot;URL for newly created LAMP stack&quot;
        },
        &quot;PublicIP&quot;: {
            &quot;Description&quot;: &quot;Public IP address of the web server&quot;,
            &quot;Value&quot;: {
                &quot;Fn::GetAtt&quot;: [
                    &quot;WebServerHost&quot;,
                    &quot;PublicIp&quot;
                ]
            }
        },
        &quot;CloudWatchLogGroupName&quot;: {
            &quot;Description&quot;: &quot;The name of the CloudWatch log group&quot;,
            &quot;Value&quot;: {
                &quot;Ref&quot;: &quot;WebServerLogGroup&quot;
            }
        }
    }
}</code></pre>
                        </div>
                     
                     <div id="YAML" name="YAML" class="section langfilter">
                        <h3 id="quickref-cloudwatchlogs-example.yaml">YAML</h3>
                        
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight ">AWSTemplateFormatVersion: &apos;2010-09-09&apos;
Description: AWS CloudFormation Sample Template for CloudWatch Logs.
Parameters:
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  SSHLocation:
    Description: The IP address range that can be used to SSH to the EC2 instances
    Type: String
    MinLength: &apos;9&apos;
    MaxLength: &apos;18&apos;
    Default: 0.0.0.0/0
    AllowedPattern: &quot;(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})&quot;
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
  OperatorEmail:
    Description: Email address to notify if there are any scaling operations
    Type: String
Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-fb8e9292
    us-west-1:
      AMI: ami-7aba833f
    us-west-2:
      AMI: ami-043a5034
    eu-west-1:
      AMI: ami-2918e35e
    ap-southeast-1:
      AMI: ami-b40d5ee6
    ap-southeast-2:
      AMI: ami-3b4bd301
    ap-northeast-1:
      AMI: ami-c9562fc8
    sa-east-1:
      AMI: ami-215dff3c
    eu-central-1:
      AMI: ami-a03503bd
Resources:
  LogRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: &apos;2012-10-17&apos;
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: &quot;/&quot;
      Policies:
      - PolicyName: LogRolePolicy
        PolicyDocument:
          Version: &apos;2012-10-17&apos;
          Statement:
          - Effect: Allow
            Action:
            - logs:Create*
            - logs:PutLogEvents
            - s3:GetObject
            Resource:
            - arn:aws:logs:*:*:*
            - arn:aws:s3:::*
  LogRoleInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: &quot;/&quot;
      Roles:
      - Ref: LogRole
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable HTTP access via port 80 and SSH access via port 22
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: &apos;80&apos;
        ToPort: &apos;80&apos;
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: &apos;22&apos;
        ToPort: &apos;22&apos;
        CidrIp:
          Ref: SSHLocation
  WebServerHost:
    Type: AWS::EC2::Instance
    Metadata:
      Comment: Install a simple PHP application
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              httpd: []
              php: []
          files:
            &quot;/tmp/cwlogs/apacheaccess.conf&quot;:
              content: !Sub |
                [general]
                state_file= /var/awslogs/agent-state
                [/var/log/httpd/access_log]
                file = /var/log/httpd/access_log
                log_group_name = ${WebServerLogGroup}
                log_stream_name = {instance_id}/apache.log
                datetime_format = %d/%b/%Y:%H:%M:%S
              mode: &apos;000400&apos;
              owner: apache
              group: apache
            &quot;/var/www/html/index.php&quot;:
              content: !Sub |
                &quot;&lt;?php&quot;
                &quot;echo &apos;&lt;h1&gt;AWS CloudFormation sample PHP application&lt;/h1&gt;&apos;;&quot;
                &quot;?&gt;&quot;
              mode: &apos;000644&apos;
              owner: apache
              group: apache
            &quot;/etc/cfn/cfn-hup.conf&quot;:
              content: !Sub |
                [main]
                stack= ${AWS::StackId}
                region=${AWS::Region}
              mode: &quot;000400&quot;
              owner: &quot;root&quot;
              group: &quot;root&quot;
            &quot;/etc/cfn/hooks.d/cfn-auto-reloader.conf&quot;:
              content: !Sub |
                [cfn-auto-reloader-hook]
                triggers=post.update
                path=Resources.WebServerHost.Metadata.AWS::CloudFormation::Init
                action=/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource WebServerHost --region ${AWS::Region}
              mode: &quot;000400&quot;
              owner: &quot;root&quot;
              group: &quot;root&quot;
          services:
            sysvinit:
              httpd:
                enabled: &apos;true&apos;
                ensureRunning: &apos;true&apos;
              sendmail:
                enabled: &apos;false&apos;
                ensureRunning: &apos;false&apos;
    CreationPolicy:
      ResourceSignal:
        Timeout: PT5M
    Properties:
      ImageId:
        Fn::FindInMap:
        - RegionMap
        - Ref: AWS::Region
        - AMI
      KeyName:
        Ref: KeyName
      InstanceType: t1.micro
      SecurityGroups:
      - Ref: WebServerSecurityGroup
      IamInstanceProfile:
        Ref: LogRoleInstanceProfile
      UserData:
        &quot;Fn::Base64&quot;:
          !Sub |
            #!/bin/bash -xe
            # Get the latest CloudFormation package
            yum update -y aws-cfn-bootstrap
            # Start cfn-init
            /opt/aws/bin/cfn-init -s ${AWS::StackId} -r WebServerHost --region ${AWS::Region} || error_exit &apos;Failed to run cfn-init&apos;
            # Start up the cfn-hup daemon to listen for changes to the EC2 instance metadata
            /opt/aws/bin/cfn-hup || error_exit &apos;Failed to start cfn-hup&apos;
            # Get the CloudWatch Logs agent
            wget https://s3.amazonaws.com/aws-cloudwatch/downloads/latest/awslogs-agent-setup.py
            # Install the CloudWatch Logs agent
            python awslogs-agent-setup.py -n -r ${AWS::Region} -c /tmp/cwlogs/apacheaccess.conf || error_exit &apos;Failed to run CloudWatch Logs agent setup&apos;
            # All done so signal success
            /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackId} --resource WebServerHost --region ${AWS::Region}
  WebServerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
  404MetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: WebServerLogGroup
      FilterPattern: &quot;[ip, identity, user_id, timestamp, request, status_code = 404, size, ...]&quot;
      MetricTransformations:
      - MetricValue: &apos;1&apos;
        MetricNamespace: test/404s
        MetricName: test404Count
  BytesTransferredMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: WebServerLogGroup
      FilterPattern: &quot;[ip, identity, user_id, timestamp, request, status_code, size, ...]&quot;
      MetricTransformations:
      - MetricValue: &quot;$size&quot;
        MetricNamespace: test/BytesTransferred
        MetricName: testBytesTransferred
  404Alarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: The number of 404s is greater than 2 over 2 minutes
      MetricName: test404Count
      Namespace: test/404s
      Statistic: Sum
      Period: &apos;60&apos;
      EvaluationPeriods: &apos;2&apos;
      Threshold: &apos;2&apos;
      AlarmActions:
      - Ref: AlarmNotificationTopic
      ComparisonOperator: GreaterThanThreshold
  BandwidthAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: The average volume of traffic is greater 3500 KB over 10 minutes
      MetricName: testBytesTransferred
      Namespace: test/BytesTransferred
      Statistic: Average
      Period: &apos;300&apos;
      EvaluationPeriods: &apos;2&apos;
      Threshold: &apos;3500&apos;
      AlarmActions:
      - Ref: AlarmNotificationTopic
      ComparisonOperator: GreaterThanThreshold
  AlarmNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
      - Endpoint:
          Ref: OperatorEmail
        Protocol: email
Outputs:
  InstanceId:
    Description: The instance ID of the web server
    Value:
      Ref: WebServerHost
  WebsiteURL:
    Value:
      !Sub &apos;http://${WebServerHost.PublicDnsName}&apos;
    Description: URL for newly created LAMP stack
  PublicIP:
    Description: Public IP address of the web server
    Value:
      !GetAtt WebServerHost.PublicIp
  CloudWatchLogGroupName:
    Description: The name of the CloudWatch log group
    Value: !Ref WebServerLogGroup</code></pre>
                        </div>
                     
                     <h2 id="quickref-cloudwatchlogs-example2">Send Logs to CloudWatch Logs from a Windows Instance</h2>
                     
                     
                     <p>The following template configures CloudWatch Logs for a Windows 2012R2 instance.</p>
                     
                     <p>The CloudWatch Logs agent on Windows (SSM agent on Windows 2012R2 and Windows 2016
                        AMIs) only sends logs after it is started, so any logs 
                        that are generated prior to startup are not sent. To work around this, the template
                        helps to ensure that the agent starts before 
                        any logs are written by:
                     </p>
                     
                     <div class="itemizedlist">
                        
                        
                        
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              <p>Configuring the agent setup as the first <code class="code">config</code> item in cfn-init <code class="code">configSets</code>.
                              </p>
                           </li>
                           <li class="listitem">
                              <p>Using <code class="code">waitAfterCompletion</code> to insert a pause after the command that starts the agent.
                              </p>
                           </li>
                        </ul>
                     </div>
                     
                     <div id="JSON" name="JSON" class="section langfilter">
                        
                        <h3 id="quickref-cloudwatchlogs-example2.json">JSON</h3>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight ">{
    &quot;AWSTemplateFormatVersion&quot;: &quot;2010-09-09&quot;,
    &quot;Description&quot;: &quot;Sample template that sets up and configures CloudWatch logs on Windows 2012R2 instance.&quot;,
    &quot;Parameters&quot;: {
      &quot;KeyPair&quot; : {
        &quot;Description&quot;: &quot;Name of an existing EC2 KeyPair to enable RDP access to the instances&quot;,
        &quot;Type&quot;: &quot;AWS::EC2::KeyPair::KeyName&quot;,
        &quot;ConstraintDescription&quot; : &quot;must be the name of an existing EC2 KeyPair.&quot;
      },
      &quot;RDPLocation&quot; : {
        &quot;Description&quot; : &quot;The IP address range that can be used to RDP to the EC2 instances&quot;,
        &quot;Type&quot;: &quot;String&quot;,
        &quot;MinLength&quot;: &quot;9&quot;,
        &quot;MaxLength&quot;: &quot;18&quot;,
        &quot;Default&quot;: &quot;0.0.0.0/0&quot;,
        &quot;AllowedPattern&quot;: &quot;(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})&quot;,
        &quot;ConstraintDescription&quot;: &quot;must be a valid IP CIDR range of the form x.x.x.x/x.&quot;
      },
     &quot;OperatorEmail&quot;: {
        &quot;Description&quot;: &quot;Email address to notify if there are any scaling operations&quot;,
        &quot;Type&quot;: &quot;String&quot;
     }
    },
    &quot;Mappings&quot;: {
      &quot;AWSAMIRegionMap&quot;: {
          &quot;ap-northeast-1&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-cb7429ac&quot;
          },
          &quot;ap-northeast-2&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-34d4075a&quot;
          },
          &quot;ap-south-1&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-dd8cfcb2&quot;
          },
          &quot;ap-southeast-1&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-e5a51786&quot;
          },
          &quot;ap-southeast-2&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-a63934c5&quot;
          },
          &quot;ca-central-1&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-d242ffb6&quot;
          },
          &quot;eu-central-1&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-d029febf&quot;
          },
          &quot;eu-west-1&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-d3dee9b5&quot;
          },
          &quot;eu-west-2&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-e5b3a681&quot;
          },
          &quot;sa-east-1&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-83f594ef&quot;
          },
          &quot;us-east-1&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-11e84107&quot;
          },
          &quot;us-east-2&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-d85773bd&quot;
          },
          &quot;us-west-1&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-052d7565&quot;
          },
          &quot;us-west-2&quot;: {
              &quot;WS2012R2&quot;: &quot;ami-09f47d69&quot;
          }
      }

    },
    &quot;Resources&quot;: {
      &quot;WebServerSecurityGroup&quot;: {
          &quot;Type&quot;: &quot;AWS::EC2::SecurityGroup&quot;,
          &quot;Properties&quot;: {
            &quot;GroupDescription&quot;: &quot;Enable HTTP access via port 80 and RDP access via port 3389&quot;,
            &quot;SecurityGroupIngress&quot; : [
              {&quot;IpProtocol&quot; : &quot;tcp&quot;, &quot;FromPort&quot; : &quot;80&quot;, &quot;ToPort&quot; : &quot;80&quot;, &quot;CidrIp&quot; : &quot;0.0.0.0/0&quot;},
              {&quot;IpProtocol&quot; : &quot;tcp&quot;, &quot;FromPort&quot; : &quot;3389&quot;, &quot;ToPort&quot; : &quot;3389&quot;, &quot;CidrIp&quot; : { &quot;Ref&quot; : &quot;RDPLocation&quot;}}
            ]
          }
        },
      &quot;LogRole&quot;: {
                    &quot;Type&quot;: &quot;AWS::IAM::Role&quot;,
                    &quot;Properties&quot;: {
                        &quot;AssumeRolePolicyDocument&quot;: {
                            &quot;Version&quot;: &quot;2012-10-17&quot;,
                            &quot;Statement&quot;: [
                                {
                                    &quot;Effect&quot;: &quot;Allow&quot;,
                                    &quot;Principal&quot;: {
                                        &quot;Service&quot;: [
                                            &quot;ec2.amazonaws.com&quot;
                                        ]
                                    },
                                    &quot;Action&quot;: [
                                        &quot;sts:AssumeRole&quot;
                                    ]
                                }
                            ]
                        },
                        &quot;ManagedPolicyArns&quot; : [ &quot;arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM&quot;],
                        &quot;Path&quot;: &quot;/&quot;,
                        &quot;Policies&quot;: [
                            {
                                &quot;PolicyName&quot;: &quot;LogRolePolicy&quot;,
                                &quot;PolicyDocument&quot;: {
                                    &quot;Version&quot;: &quot;2012-10-17&quot;,
                                    &quot;Statement&quot;: [
                                        {
                                            &quot;Effect&quot;: &quot;Allow&quot;,
                                            &quot;Action&quot;: [
                                              &quot;logs:Create*&quot;,
                                              &quot;logs:PutLogEvents&quot;,
                                              &quot;s3:GetObject&quot;
                                            ],
                                            &quot;Resource&quot;: [
                                              &quot;arn:aws:logs:*:*:*&quot;,
                                              &quot;arn:aws:s3:::*&quot;
                                            ]
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                },
      &quot;LogRoleInstanceProfile&quot;: {
                    &quot;Type&quot;: &quot;AWS::IAM::InstanceProfile&quot;,
                    &quot;Properties&quot;: {
                        &quot;Path&quot;: &quot;/&quot;,
                        &quot;Roles&quot;: [
                            {
                                &quot;Ref&quot;: &quot;LogRole&quot;
                            }
                        ]
                    }
                },
      &quot;WebServerHost&quot;: {
        &quot;Type&quot;: &quot;AWS::EC2::Instance&quot;,
        &quot;CreationPolicy&quot; : {
          &quot;ResourceSignal&quot; : {
            &quot;Timeout&quot; : &quot;PT15M&quot;
          }
        },
        &quot;Metadata&quot;: {
          &quot;AWS::CloudFormation::Init&quot; : {
            &quot;configSets&quot; : {
              &quot;config&quot;: [
                &quot;00-ConfigureCWLogs&quot;,
                &quot;01-InstallWebServer&quot;,
                &quot;02-ConfigureApplication&quot;,
                &quot;03-Finalize&quot;
              ]
            },
            &quot;00-ConfigureCWLogs&quot; : {
              &quot;files&quot;: {
                  &quot;C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json&quot;: {
                    &quot;content&quot;: {
                        &quot;Fn::Join&quot;: [
                          &quot;&quot;,
                          [
                                        &quot;{&quot;,
                                        &quot;  \&quot;IsEnabled\&quot; : true,&quot;,
                                        &quot;  \&quot;EngineConfiguration\&quot; : {&quot;,
                                        &quot;    \&quot;PollInterval\&quot; : \&quot;00:00:05\&quot;,&quot;,
                                        &quot;    \&quot;Components\&quot; : [{&quot;,
                                        &quot;      \&quot;Id\&quot; : \&quot;ApplicationEventLog\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot; : \&quot;AWS.EC2.Windows.CloudWatch.EventLog.EventLogInputComponent,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot; : {&quot;,
                                        &quot;        \&quot;LogName\&quot; : \&quot;Application\&quot;,&quot;,
                                        &quot;        \&quot;Levels\&quot; : \&quot;7\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot; : \&quot;SystemEventLog\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot; : \&quot;AWS.EC2.Windows.CloudWatch.EventLog.EventLogInputComponent,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot; : {&quot;,
                                        &quot;        \&quot;LogName\&quot; : \&quot;System\&quot;,&quot;,
                                        &quot;        \&quot;Levels\&quot; : \&quot;7\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot; : \&quot;SecurityEventLog\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot; : \&quot;AWS.EC2.Windows.CloudWatch.EventLog.EventLogInputComponent,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot; : {&quot;,
                                        &quot;        \&quot;LogName\&quot; : \&quot;Security\&quot;,&quot;,
                                        &quot;        \&quot;Levels\&quot; : \&quot;7\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot; : \&quot;EC2ConfigLog\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot;: \&quot;AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot;: {&quot;,
                                        &quot;        \&quot;LogDirectoryPath\&quot;: \&quot;C:\\\\Program Files\\\\Amazon\\\\Ec2ConfigService\\\\Logs\&quot;,&quot;,
                                        &quot;        \&quot;TimestampFormat\&quot;: \&quot;yyyy-MM-ddTHH:mm:ss.fffZ:\&quot;,&quot;,
                                        &quot;        \&quot;Encoding\&quot;: \&quot;ASCII\&quot;,&quot;,
                                        &quot;        \&quot;Filter\&quot;: \&quot;EC2ConfigLog.txt\&quot;,&quot;,
                                        &quot;        \&quot;CultureName\&quot;: \&quot;en-US\&quot;,&quot;,
                                        &quot;        \&quot;TimeZoneKind\&quot;: \&quot;UTC\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot;: \&quot;CfnInitLog\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot;: \&quot;AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot;: {&quot;,
                                        &quot;        \&quot;LogDirectoryPath\&quot;: \&quot;C:\\\\cfn\\\\log\&quot;,&quot;,
                                        &quot;        \&quot;TimestampFormat\&quot;: \&quot;yyyy-MM-dd HH:mm:ss,fff\&quot;,&quot;,
                                        &quot;        \&quot;Encoding\&quot;: \&quot;ASCII\&quot;,&quot;,
                                        &quot;        \&quot;Filter\&quot;: \&quot;cfn-init.log\&quot;,&quot;,
                                        &quot;        \&quot;CultureName\&quot;: \&quot;en-US\&quot;,&quot;,
                                        &quot;        \&quot;TimeZoneKind\&quot;: \&quot;Local\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot; : \&quot;IISLogs\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot; : \&quot;AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot; : {&quot;,
                                        &quot;        \&quot;LogDirectoryPath\&quot; : \&quot;C:\\\\inetpub\\\\logs\\\\LogFiles\\\\W3SVC1\&quot;,&quot;,
                                        &quot;        \&quot;TimestampFormat\&quot; : \&quot;yyyy-MM-dd HH:mm:ss\&quot;,&quot;,
                                        &quot;        \&quot;Encoding\&quot; : \&quot;UTF-8\&quot;,&quot;,
                                        &quot;        \&quot;Filter\&quot; : \&quot;\&quot;,&quot;,
                                        &quot;        \&quot;CultureName\&quot; : \&quot;en-US\&quot;,&quot;,
                                        &quot;        \&quot;TimeZoneKind\&quot; : \&quot;UTC\&quot;,&quot;,
                                        &quot;        \&quot;LineCount\&quot; : \&quot;3\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot; : \&quot;MemoryPerformanceCounter\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot; : \&quot;AWS.EC2.Windows.CloudWatch.PerformanceCounterComponent.PerformanceCounterInputComponent,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot; : {&quot;,
                                        &quot;        \&quot;CategoryName\&quot; : \&quot;Memory\&quot;,&quot;,
                                        &quot;        \&quot;CounterName\&quot; : \&quot;Available MBytes\&quot;,&quot;,
                                        &quot;        \&quot;InstanceName\&quot; : \&quot;\&quot;,&quot;,
                                        &quot;        \&quot;MetricName\&quot; : \&quot;Memory\&quot;,&quot;,
                                        &quot;        \&quot;Unit\&quot; : \&quot;Megabytes\&quot;,&quot;,
                                        &quot;        \&quot;DimensionName\&quot; : \&quot;\&quot;,&quot;,
                                        &quot;        \&quot;DimensionValue\&quot; : \&quot;\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot;: \&quot;CloudWatchApplicationEventLog\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot;: \&quot;AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot;: {&quot;,
                                        &quot;        \&quot;AccessKey\&quot;: \&quot;\&quot;,&quot;,
                                        &quot;        \&quot;SecretKey\&quot;: \&quot;\&quot;,&quot;,
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;Region\&quot;: \&quot;${AWS::Region}\&quot;,&quot;
                                        },
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;LogGroup\&quot;: \&quot;${LogGroup}\&quot;,&quot;
                                        },
                                        &quot;        \&quot;LogStream\&quot;: \&quot;{instance_id}/ApplicationEventLog\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot;: \&quot;CloudWatchSystemEventLog\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot;: \&quot;AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot;: {&quot;,
                                        &quot;        \&quot;AccessKey\&quot;: \&quot;\&quot;,&quot;,
                                        &quot;        \&quot;SecretKey\&quot;: \&quot;\&quot;,&quot;,
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;Region\&quot;: \&quot;${AWS::Region}\&quot;,&quot;
                                        },
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;LogGroup\&quot;: \&quot;${LogGroup}\&quot;,&quot;
                                        },
                                        &quot;        \&quot;LogStream\&quot;: \&quot;{instance_id}/SystemEventLog\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot;: \&quot;CloudWatchSecurityEventLog\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot;: \&quot;AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot;: {&quot;,
                                        &quot;        \&quot;AccessKey\&quot;: \&quot;\&quot;,&quot;,
                                        &quot;        \&quot;SecretKey\&quot;: \&quot;\&quot;,&quot;,
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;Region\&quot;: \&quot;${AWS::Region}\&quot;,&quot;
                                        },
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;LogGroup\&quot;: \&quot;${LogGroup}\&quot;,&quot;
                                        },
                                        &quot;        \&quot;LogStream\&quot;: \&quot;{instance_id}/SecurityEventLog\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot;: \&quot;CloudWatchEC2ConfigLog\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot;: \&quot;AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot;: {&quot;,
                                        &quot;        \&quot;AccessKey\&quot;: \&quot;\&quot;,&quot;,
                                        &quot;        \&quot;SecretKey\&quot;: \&quot;\&quot;,&quot;,
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;Region\&quot;: \&quot;${AWS::Region}\&quot;,&quot;
                                        },
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;LogGroup\&quot;: \&quot;${LogGroup}\&quot;,&quot;
                                        },
                                        &quot;        \&quot;LogStream\&quot;: \&quot;{instance_id}/EC2ConfigLog\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot;: \&quot;CloudWatchCfnInitLog\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot;: \&quot;AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot;: {&quot;,
                                        &quot;        \&quot;AccessKey\&quot;: \&quot;\&quot;,&quot;,
                                        &quot;        \&quot;SecretKey\&quot;: \&quot;\&quot;,&quot;,
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;Region\&quot;: \&quot;${AWS::Region}\&quot;,&quot;
                                        },
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;LogGroup\&quot;: \&quot;${LogGroup}\&quot;,&quot;
                                        },
                                        &quot;        \&quot;LogStream\&quot;: \&quot;{instance_id}/CfnInitLog\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot;: \&quot;CloudWatchIISLogs\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot;: \&quot;AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot;: {&quot;,
                                        &quot;        \&quot;AccessKey\&quot;: \&quot;\&quot;,&quot;,
                                        &quot;        \&quot;SecretKey\&quot;: \&quot;\&quot;,&quot;,
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;Region\&quot;: \&quot;${AWS::Region}\&quot;,&quot;
                                        },
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;LogGroup\&quot;: \&quot;${LogGroup}\&quot;,&quot;
                                        },
                                        &quot;        \&quot;LogStream\&quot;: \&quot;{instance_id}/IISLogs\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    },&quot;,
                                        &quot;    {&quot;,
                                        &quot;      \&quot;Id\&quot; : \&quot;CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;FullName\&quot; : \&quot;AWS.EC2.Windows.CloudWatch.CloudWatch.CloudWatchOutputComponent,AWS.EC2.Windows.CloudWatch\&quot;,&quot;,
                                        &quot;      \&quot;Parameters\&quot; : {&quot;,
                                        &quot;        \&quot;AccessKey\&quot; : \&quot;\&quot;,&quot;,
                                        &quot;        \&quot;SecretKey\&quot; : \&quot;\&quot;,&quot;,
                                        {
                                            &quot;Fn::Sub&quot;: &quot;        \&quot;Region\&quot;: \&quot;${AWS::Region}\&quot;,&quot;
                                        },
                                        &quot;        \&quot;NameSpace\&quot; : \&quot;Windows/Default\&quot;&quot;,
                                        &quot;      }&quot;,
                                        &quot;    }],&quot;,
                                        &quot;    \&quot;Flows\&quot;: {&quot;,
                                        &quot;      \&quot;Flows\&quot;: [&quot;,
                                        &quot;        \&quot;ApplicationEventLog,CloudWatchApplicationEventLog\&quot;,&quot;,
                                        &quot;        \&quot;SystemEventLog,CloudWatchSystemEventLog\&quot;,&quot;,
                                        &quot;        \&quot;SecurityEventLog,CloudWatchSecurityEventLog\&quot;,&quot;,
                                        &quot;        \&quot;EC2ConfigLog,CloudWatchEC2ConfigLog\&quot;,&quot;,
                                        &quot;        \&quot;CfnInitLog,CloudWatchCfnInitLog\&quot;,&quot;,
                                        &quot;        \&quot;IISLogs,CloudWatchIISLogs\&quot;,&quot;,
                                        &quot;        \&quot;MemoryPerformanceCounter,CloudWatch\&quot;&quot;,
                                        &quot;      ]&quot;,
                                        &quot;    }&quot;,
                                        &quot;  }&quot;,
                                        &quot;}&quot;
                                    ]
                          ]
                      }
                  }
              },
              &quot;commands&quot;: {
                  &quot;0-enableSSM&quot; : {
                    &quot;command&quot; : &quot;powershell.exe -Command \&quot;Set-Service -Name AmazonSSMAgent -StartupType Automatic\&quot; &quot;,
                    &quot;waitAfterCompletion&quot; : &quot;0&quot;
                  },
                  &quot;1-restartSSM&quot;: {
                     &quot;command&quot; : &quot;powershell.exe -Command \&quot;Restart-Service AmazonSSMAgent \&quot;&quot;,
                     &quot;waitAfterCompletion&quot; : &quot;30&quot;
                  }
                }
              },
            &quot;01-InstallWebServer&quot;: {
                &quot;commands&quot;: {
                  &quot;01_install_webserver&quot;: {
                      &quot;command&quot;: &quot;powershell.exe -Command \&quot;Install-WindowsFeature Web-Server -IncludeAllSubFeature\&quot;&quot;,
                      &quot;waitAfterCompletion&quot;: &quot;0&quot;
                      }
                 }
            },
            &quot;02-ConfigureApplication&quot;: {
                &quot;files&quot;: {
                                  &quot;c:\\Inetpub\\wwwroot\\index.htm&quot;: {
                                      &quot;content&quot;: {
                                          &quot;Fn::Join&quot;: [
                                              &quot;\n&quot;,
                                              [
                                                  &quot;&lt;html&gt;&quot;,
                                                  &quot;&lt;head&gt;&quot;,
                                                  &quot;&lt;title&gt;Test Application&lt;/title&gt;&quot;,
                                                  &quot;&lt;/head&gt;&quot;,
                                                  &quot;&lt;body&gt;&quot;,
                                                  &quot;&lt;h1&gt;Congratulations!! Your IIS Web Server is configured.&lt;/h1&gt;&quot;,
                                                  &quot;&lt;/body&gt;&quot;,
                                                  &quot;&lt;/html&gt;&quot;
                                              ]
                                          ]
                                      }
                                  }
                         }
            },
            &quot;03-Finalize&quot;: {
                &quot;commands&quot;: {
                  &quot;00_signal_success&quot;: {
                      &quot;command&quot;: { &quot;Fn::Sub&quot; : &quot;cfn-signal.exe -e 0 --resource WebServerHost --stack ${AWS::StackName} --region ${AWS::Region} &quot; },
                      &quot;waitAfterCompletion&quot;: &quot;0&quot;
                      }
                 }
            }
          }
        },
        &quot;Properties&quot;: {
            &quot;KeyName&quot;: { &quot;Ref&quot; : &quot;KeyPair&quot;},
            &quot;ImageId&quot;: {
                &quot;Fn::FindInMap&quot;: [
                    &quot;AWSAMIRegionMap&quot;,
                    {
                        &quot;Ref&quot;: &quot;AWS::Region&quot;
                    },
                    &quot;WS2012R2&quot;
                ]
            },
            &quot;InstanceType&quot;: &quot;t2.xlarge&quot;,
            &quot;SecurityGroupIds&quot; : [{ &quot;Ref&quot; : &quot;WebServerSecurityGroup&quot;}],
            &quot;IamInstanceProfile&quot; : { &quot;Ref&quot; : &quot;LogRoleInstanceProfile&quot;},
            &quot;UserData&quot;: {
                &quot;Fn::Base64&quot;: {
                    &quot;Fn::Join&quot;: [
                        &quot;\n&quot;,
                        [
                           &quot;&lt;script&gt;&quot;,
                            &quot;wmic product where \&quot;description=&apos;Amazon SSM Agent&apos; \&quot; uninstall&quot;,
                            &quot;wmic product where \&quot;description=&apos;aws-cfn-bootstrap&apos; \&quot; uninstall &quot;,
                            &quot;start /wait c:\\Windows\\system32\\msiexec /passive /qn /i https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-win64-latest.msi&quot;,
                            &quot;powershell.exe -Command \&quot;iwr https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/windows_amd64/AmazonSSMAgentSetup.exe -UseBasicParsing -OutFile C:\\AmazonSSMAgentSetup.exe\&quot;&quot;,
                            &quot;start /wait C:\\AmazonSSMAgentSetup.exe /install /quiet&quot;,
                            { &quot;Fn::Sub&quot; : &quot;cfn-init.exe -v -c config -s ${AWS::StackName} --resource WebServerHost --region ${AWS::Region} &quot; },
                            &quot;&lt;/script&gt;&quot;
                        ]
                    ]
                }
              }
            }
        },
      &quot;LogGroup&quot;: {
        &quot;Type&quot;: &quot;AWS::Logs::LogGroup&quot;,
        &quot;Properties&quot;: {
          &quot;RetentionInDays&quot;: 7
        }
      },
      &quot;404MetricFilter&quot;: {
        &quot;Type&quot;: &quot;AWS::Logs::MetricFilter&quot;,
        &quot;Properties&quot;: {
            &quot;LogGroupName&quot;: {
              &quot;Ref&quot;: &quot;LogGroup&quot;
            },
            &quot;FilterPattern&quot;: &quot;[timestamps,serverip, method, uri, query, port, dash, clientip, useragent, status_code = 404, ...]&quot;,
            &quot;MetricTransformations&quot;: [
                {
                    &quot;MetricValue&quot;: &quot;1&quot;,
                    &quot;MetricNamespace&quot;: &quot;test/404s&quot;,
                    &quot;MetricName&quot;: &quot;test404Count&quot;
                }
            ]
        }
      },
      &quot;404Alarm&quot;: {
          &quot;Type&quot;: &quot;AWS::CloudWatch::Alarm&quot;,
          &quot;Properties&quot;: {
              &quot;AlarmDescription&quot;: &quot;The number of 404s is greater than 2 over 2 minutes&quot;,
              &quot;MetricName&quot;: &quot;test404Count&quot;,
              &quot;Namespace&quot;: &quot;test/404s&quot;,
              &quot;Statistic&quot;: &quot;Sum&quot;,
              &quot;Period&quot;: &quot;60&quot;,
              &quot;EvaluationPeriods&quot;: &quot;2&quot;,
              &quot;Threshold&quot;: &quot;2&quot;,
              &quot;AlarmActions&quot;: [
                  {
                      &quot;Ref&quot;: &quot;AlarmNotificationTopic&quot;
                  }
              ],
              &quot;ComparisonOperator&quot;: &quot;GreaterThanThreshold&quot;
          }
      },
      &quot;AlarmNotificationTopic&quot;: {
        &quot;Type&quot;: &quot;AWS::SNS::Topic&quot;,
        &quot;Properties&quot;: {
          &quot;Subscription&quot;: [
              {
                  &quot;Endpoint&quot;: { &quot;Ref&quot;: &quot;OperatorEmail&quot; },
                  &quot;Protocol&quot;: &quot;email&quot;
              }
           ]
        }
      }
    },
    &quot;Outputs&quot;: {
        &quot;InstanceId&quot;: {
            &quot;Description&quot;: &quot;The instance ID of the web server&quot;,
            &quot;Value&quot;: {
                &quot;Ref&quot;: &quot;WebServerHost&quot;
            }
        },
        &quot;WebsiteURL&quot; : {
          &quot;Value&quot; : { &quot;Fn::Join&quot; : [&quot;&quot;, [&quot;http://&quot;, { &quot;Fn::GetAtt&quot; : [ &quot;WebServerHost&quot;, &quot;PublicDnsName&quot; ]}]] },
          &quot;Description&quot; : &quot;URL for newly created IIS web server&quot;
        },
        &quot;PublicIP&quot;: {
            &quot;Description&quot;: &quot;Public IP address of the web server&quot;,
            &quot;Value&quot;: {
                &quot;Fn::GetAtt&quot;: [
                    &quot;WebServerHost&quot;,
                    &quot;PublicIp&quot;
                ]
            }
        },
        &quot;CloudWatchLogGroupName&quot;: {
            &quot;Description&quot;: &quot;The name of the CloudWatch log group&quot;,
            &quot;Value&quot;: {
                &quot;Ref&quot;: &quot;LogGroup&quot;
            }
        }
    }
}
</code></pre>
                        </div>
                     
                     <div id="YAML" name="YAML" class="section langfilter">
                        
                        <h3 id="quickref-cloudwatchlogs-example2.yaml">YAML</h3>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight ">AWSTemplateFormatVersion: &apos;2010-09-09&apos;
Description: Sample template that sets up and configures CloudWatch logs on Windows 2012R2 instance
  instance.
Parameters:
  KeyPair:
    Description: Name of an existing EC2 KeyPair to enable RDP access to the instances
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  RDPLocation:
    Description: The IP address range that can be used to RDP to the EC2 instances
    Type: String
    MinLength: &apos;9&apos;
    MaxLength: &apos;18&apos;
    Default: 0.0.0.0/0
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
  OperatorEmail:
    Description: Email address to notify if there are any scaling operations
    Type: String
Mappings:
  AWSAMIRegionMap:
    ap-northeast-1:
      WS2012R2: ami-cb7429ac
    ap-northeast-2:
      WS2012R2: ami-34d4075a
    ap-south-1:
      WS2012R2: ami-dd8cfcb2
    ap-southeast-1:
      WS2012R2: ami-e5a51786
    ap-southeast-2:
      WS2012R2: ami-a63934c5
    ca-central-1:
      WS2012R2: ami-d242ffb6
    eu-central-1:
      WS2012R2: ami-d029febf
    eu-west-1:
      WS2012R2: ami-d3dee9b5
    eu-west-2:
      WS2012R2: ami-e5b3a681
    sa-east-1:
      WS2012R2: ami-83f594ef
    us-east-1:
      WS2012R2: ami-11e84107
    us-east-2:
      WS2012R2: ami-d85773bd
    us-west-1:
      WS2012R2: ami-052d7565
    us-west-2:
      WS2012R2: ami-09f47d69
Resources:
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable HTTP access via port 80 and RDP access via port 3389
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: &apos;80&apos;
        ToPort: &apos;80&apos;
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: &apos;3389&apos;
        ToPort: &apos;3389&apos;
        CidrIp: !Ref &apos;RDPLocation&apos;
  LogRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: &apos;2012-10-17&apos;
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM
      Path: /
      Policies:
      - PolicyName: LogRolePolicy
        PolicyDocument:
          Version: &apos;2012-10-17&apos;
          Statement:
          - Effect: Allow
            Action:
            - logs:Create*
            - logs:PutLogEvents
            - s3:GetObject
            Resource:
            - arn:aws:logs:*:*:*
            - arn:aws:s3:::*
  LogRoleInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
      - !Ref &apos;LogRole&apos;
  WebServerHost:
    Type: AWS::EC2::Instance
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          config:
          - 00-ConfigureCWLogs
          - 01-InstallWebServer
          - 02-ConfigureApplication
          - 03-Finalize
        00-ConfigureCWLogs:
          files:
            C:\Program Files\Amazon\SSM\Plugins\awsCloudWatch\AWS.EC2.Windows.CloudWatch.json:
              content: !Sub |
                {
                  &quot;EngineConfiguration&quot;: {
                      &quot;Components&quot;: [
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.EventLog.EventLogInputComponent,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;ApplicationEventLog&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;Levels&quot;: &quot;7&quot;,
                                  &quot;LogName&quot;: &quot;Application&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.EventLog.EventLogInputComponent,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;SystemEventLog&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;Levels&quot;: &quot;7&quot;,
                                  &quot;LogName&quot;: &quot;System&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.EventLog.EventLogInputComponent,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;SecurityEventLog&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;Levels&quot;: &quot;7&quot;,
                                  &quot;LogName&quot;: &quot;Security&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;EC2ConfigLog&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;CultureName&quot;: &quot;en-US&quot;,
                                  &quot;Encoding&quot;: &quot;ASCII&quot;,
                                  &quot;Filter&quot;: &quot;EC2ConfigLog.txt&quot;,
                                  &quot;LogDirectoryPath&quot;: &quot;C:\\Program Files\\Amazon\\Ec2ConfigService\\Logs&quot;,
                                  &quot;TimeZoneKind&quot;: &quot;UTC&quot;,
                                  &quot;TimestampFormat&quot;: &quot;yyyy-MM-ddTHH:mm:ss.fffZ:&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;CfnInitLog&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;CultureName&quot;: &quot;en-US&quot;,
                                  &quot;Encoding&quot;: &quot;ASCII&quot;,
                                  &quot;Filter&quot;: &quot;cfn-init.log&quot;,
                                  &quot;LogDirectoryPath&quot;: &quot;C:\\cfn\\log&quot;,
                                  &quot;TimeZoneKind&quot;: &quot;Local&quot;,
                                  &quot;TimestampFormat&quot;: &quot;yyyy-MM-dd HH:mm:ss,fff&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;IISLogs&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;CultureName&quot;: &quot;en-US&quot;,
                                  &quot;Encoding&quot;: &quot;UTF-8&quot;,
                                  &quot;Filter&quot;: &quot;&quot;,
                                  &quot;LineCount&quot;: &quot;3&quot;,
                                  &quot;LogDirectoryPath&quot;: &quot;C:\\inetpub\\logs\\LogFiles\\W3SVC1&quot;,
                                  &quot;TimeZoneKind&quot;: &quot;UTC&quot;,
                                  &quot;TimestampFormat&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.PerformanceCounterComponent.PerformanceCounterInputComponent,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;MemoryPerformanceCounter&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;CategoryName&quot;: &quot;Memory&quot;,
                                  &quot;CounterName&quot;: &quot;Available MBytes&quot;,
                                  &quot;DimensionName&quot;: &quot;&quot;,
                                  &quot;DimensionValue&quot;: &quot;&quot;,
                                  &quot;InstanceName&quot;: &quot;&quot;,
                                  &quot;MetricName&quot;: &quot;Memory&quot;,
                                  &quot;Unit&quot;: &quot;Megabytes&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;CloudWatchApplicationEventLog&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;AccessKey&quot;: &quot;&quot;,
                                  &quot;LogGroup&quot;: &quot;${LogGroup}&quot;,
                                  &quot;LogStream&quot;: &quot;{instance_id}/ApplicationEventLog&quot;,
                                  &quot;Region&quot;: &quot;${AWS::Region}&quot;,
                                  &quot;SecretKey&quot;: &quot;&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;CloudWatchSystemEventLog&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;AccessKey&quot;: &quot;&quot;,
                                  &quot;LogGroup&quot;: &quot;${LogGroup}&quot;,
                                  &quot;LogStream&quot;: &quot;{instance_id}/SystemEventLog&quot;,
                                  &quot;Region&quot;: &quot;${AWS::Region}&quot;,
                                  &quot;SecretKey&quot;: &quot;&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;CloudWatchSecurityEventLog&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;AccessKey&quot;: &quot;&quot;,
                                  &quot;LogGroup&quot;: &quot;${LogGroup}&quot;,
                                  &quot;LogStream&quot;: &quot;{instance_id}/SecurityEventLog&quot;,
                                  &quot;Region&quot;: &quot;${AWS::Region}&quot;,
                                  &quot;SecretKey&quot;: &quot;&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;CloudWatchEC2ConfigLog&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;AccessKey&quot;: &quot;&quot;,
                                  &quot;LogGroup&quot;: &quot;${LogGroup}&quot;,
                                  &quot;LogStream&quot;: &quot;{instance_id}/EC2ConfigLog&quot;,
                                  &quot;Region&quot;: &quot;${AWS::Region}&quot;,
                                  &quot;SecretKey&quot;: &quot;&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;CloudWatchCfnInitLog&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;AccessKey&quot;: &quot;&quot;,
                                  &quot;LogGroup&quot;: &quot;${LogGroup}&quot;,
                                  &quot;LogStream&quot;: &quot;{instance_id}/CfnInitLog&quot;,
                                  &quot;Region&quot;: &quot;${AWS::Region}&quot;,
                                  &quot;SecretKey&quot;: &quot;&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;CloudWatchIISLogs&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;AccessKey&quot;: &quot;&quot;,
                                  &quot;LogGroup&quot;: &quot;${LogGroup}&quot;,
                                  &quot;LogStream&quot;: &quot;{instance_id}/IISLogs&quot;,
                                  &quot;Region&quot;: &quot;${AWS::Region}&quot;,
                                  &quot;SecretKey&quot;: &quot;&quot;
                              }
                          },
                          {
                              &quot;FullName&quot;: &quot;AWS.EC2.Windows.CloudWatch.CloudWatch.CloudWatchOutputComponent,AWS.EC2.Windows.CloudWatch&quot;,
                              &quot;Id&quot;: &quot;CloudWatch&quot;,
                              &quot;Parameters&quot;: {
                                  &quot;AccessKey&quot;: &quot;&quot;,
                                  &quot;NameSpace&quot;: &quot;Windows/Default&quot;,
                                  &quot;Region&quot;: &quot;${AWS::Region}&quot;,
                                  &quot;SecretKey&quot;: &quot;&quot;
                              }
                          }
                      ],
                      &quot;Flows&quot;: {
                          &quot;Flows&quot;: [
                              &quot;ApplicationEventLog,CloudWatchApplicationEventLog&quot;,
                              &quot;SystemEventLog,CloudWatchSystemEventLog&quot;,
                              &quot;SecurityEventLog,CloudWatchSecurityEventLog&quot;,
                              &quot;EC2ConfigLog,CloudWatchEC2ConfigLog&quot;,
                              &quot;CfnInitLog,CloudWatchCfnInitLog&quot;,
                              &quot;IISLogs,CloudWatchIISLogs&quot;,
                              &quot;MemoryPerformanceCounter,CloudWatch&quot;
                          ]
                      },
                      &quot;PollInterval&quot;: &quot;00:00:05&quot;
                  },
                  &quot;IsEnabled&quot;: true
                }
          commands:
            0-enableSSM:
              command: &apos;powershell.exe -Command &quot;Set-Service -Name AmazonSSMAgent -StartupType Automatic&quot; &apos;
              waitAfterCompletion: &apos;0&apos;
            1-restartSSM:
              command: &apos;powershell.exe -Command &quot;Restart-Service AmazonSSMAgent &quot;&apos;
              waitAfterCompletion: &apos;30&apos;
        01-InstallWebServer:
          commands:
            01_install_webserver:
              command: powershell.exe -Command &quot;Install-WindowsFeature Web-Server  -IncludeAllSubFeature&quot;
              waitAfterCompletion: &apos;0&apos;
        02-ConfigureApplication:
          files:
            c:\Inetpub\wwwroot\index.htm:
              content: &apos;&lt;html&gt;
                &lt;head&gt;
                &lt;title&gt;Test Application Page&lt;/title&gt;
                &lt;/head&gt;
                &lt;body&gt;
                &lt;h1&gt;Congratulations !! Your IIS server is configured.&lt;/h1&gt;
                &lt;/body&gt;
                &lt;/html&gt;&apos;
        03-Finalize:
          commands:
            00_signal_success:
              command: !Sub &apos;cfn-signal.exe -e 0 --resource WebServerHost --stack ${AWS::StackName} --region ${AWS::Region}&apos;
              waitAfterCompletion: &apos;0&apos;
    Properties:
      KeyName: !Ref &apos;KeyPair&apos;
      ImageId: !FindInMap [AWSAMIRegionMap, !Ref &apos;AWS::Region&apos;, WS2012R2]
      InstanceType: t2.xlarge
      SecurityGroupIds: 
         - !Ref &apos;WebServerSecurityGroup&apos;
      IamInstanceProfile: !Ref &apos;LogRoleInstanceProfile&apos;
      UserData: 
        Fn::Base64: 
         !Sub |
          &lt;script&gt;
          wmic product where &quot;description=&apos;Amazon SSM Agent&apos; &quot; uninstall
          wmic product where &quot;description=&apos;aws-cfn-bootstrap&apos; &quot; uninstall 
          start /wait c:\\Windows\\system32\\msiexec /passive /qn /i https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-win64-latest.msi
          powershell.exe -Command &quot;iwr https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/windows_amd64/AmazonSSMAgentSetup.exe  -UseBasicParsing -OutFile C:\\AmazonSSMAgentSetup.exe&quot;
          start /wait C:\\AmazonSSMAgentSetup.exe /install /quiet
          cfn-init.exe -v -c config -s ${AWS::StackName} --resource WebServerHost --region ${AWS::Region} 
          &lt;/script&gt;
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
  404MetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref &apos;LogGroup&apos;
      FilterPattern: &apos;[timestamps, serverip, method, uri, query, port, dash, clientip, useragent, status_code = 404, ...]&apos;
      MetricTransformations:
      - MetricValue: &apos;1&apos;
        MetricNamespace: test/404s
        MetricName: test404Count
  404Alarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: The number of 404s is greater than 2 over 2 minutes
      MetricName: test404Count
      Namespace: test/404s
      Statistic: Sum
      Period: &apos;60&apos;
      EvaluationPeriods: &apos;2&apos;
      Threshold: &apos;2&apos;
      AlarmActions:
      - !Ref &apos;AlarmNotificationTopic&apos;
      ComparisonOperator: GreaterThanThreshold
  AlarmNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
      - Endpoint: !Ref &apos;OperatorEmail&apos;
        Protocol: email
Outputs:
  InstanceId:
    Description: The instance ID of the web server
    Value: !Ref &apos;WebServerHost&apos;
  WebsiteURL:
    Value: !Sub &apos;http://${WebServerHost.PublicDnsName}&apos;
    Description: URL for newly created IIS web server
  PublicIP:
    Description: Public IP address of the web server
    Value: !GetAtt &apos;WebServerHost.PublicIp&apos;
  CloudWatchLogGroupName:
    Description: The name of the CloudWatch log group
    Value: !Ref &apos;LogGroup&apos;
</code></pre>
                        </div>
                     
                     <h2 id="w2ab2c17c24c31c11">See Also</h2>
                     
                     
                     <p>For more information about CloudWatch Logs resources, see <a href="aws-resource-logs-loggroup.html">AWS::Logs::LogGroup</a> or <a href="aws-resource-logs-metricfilter.html">AWS::Logs::MetricFilter</a>.
                     </p>
                     
                  </div>
                  <noscript>
                     <div>
                        <div>
                           <div>
                              <div id="js_error_message">
                                 <p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p>
                                 <p>To use the AWS Documentation, Javascript must be enabled. Please refer to your browser's
                                    Help pages for instructions.
                                 </p>
                              </div>
                           </div>
                        </div>
                     </div>
                  </noscript>
                  <div id="main-col-footer">
                     <div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div>
                     <div id="next"><a class="awstoc" accesskey="p" href="quickref-cloudwatch.html">&#xAB; Previous </a><a class="awstoc" accesskey="n" href="quickref-dynamodb.html">Next &#xBB;</a></div>
                     <div id="copyright-main-footer">&#xA9; 2018, Amazon Web Services, Inc. or its affiliates. All rights reserved.</div>
                  </div>
               </div>
            </div>
            <div id="right-expanded">
               <div id="right-content-wrapper">
                  <div id="pagetoc">
                     <p>On this page:</p>
                     <ul class="pagetoc">
                        <li class="pagetoc" name="Send Logs to CloudWatch Logs from a Linux Instance"><a class="pagetoc" href="#quickref-cloudwatchlogs-example1">Send Logs to CloudWatch Logs from a Linux Instance</a></li>
                        <li class="pagetoc" name="Send Logs to CloudWatch Logs from a Windows Instance"><a class="pagetoc" href="#quickref-cloudwatchlogs-example2">Send Logs to CloudWatch Logs from a Windows Instance</a></li>
                        <li class="pagetoc" name="See Also"><a class="pagetoc" href="#w2ab2c17c24c31c11">See Also</a></li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      </div>
      
      <!-- SiteCatalyst code version: H.25.2.
            Copyright 1996-2012 Adobe, Inc. All Rights Reserved
            More info available at http://www.omniture.com --><script language="JavaScript" type="text/javascript" src="https://a0.awsstatic.com/s_code/js/1.0/awshome_s_code.js"></script><script language="JavaScript" type="text/javascript">
         <!--

            // Documentation Service Name
            s.prop66='AWS CloudFormation';
            s.eVar66='D=c66';
  
            // Documentation Guide Name                                                                 
            s.prop65='User Guide';
            s.eVar65='D=c65';

            var s_code=s.t();if(s_code)document.write(s_code)//--></script><script language="JavaScript" type="text/javascript">
         <!--
                if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
                //--></script><noscript><img src="https://amazonwebservices.d2.sc.omtrdc.net/b/ss/awsamazondev/1/H.25.2--NS/0" height="1" width="1" border="0" alt="" /></noscript>
      <!--/DO NOT REMOVE/-->
      <!-- End SiteCatalyst code version: H.25.2. -->
   
</body></html>