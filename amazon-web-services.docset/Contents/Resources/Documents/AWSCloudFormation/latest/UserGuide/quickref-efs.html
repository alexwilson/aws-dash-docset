<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Amazon Elastic File System Sample Template - AWS CloudFormation</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="home" href="#top">
      <link rel="up" href="CHAP_TemplateQuickRef.html" title="Template Snippets">
      <link rel="prev" href="quickref-ecs.html" title="Amazon Elastic Container Service Template Snippets">
      <link rel="next" href="quickref-elasticbeanstalk.html" title="Elastic Beanstalk Template Snippets">
      <meta name="description" content="Use an Amazon Elastic File System sample template to describe Amazon Elastic File System resources in your AWS CloudFormation templates.">
      <meta name="keywords" content="CloudFormation,AWSCloudFormation,resource provisioning,resource configuration,infrastructure management,CloudFormer,CloudFormation Designer,CloudFormation stack,CloudFormation stackset,CloudFormation template,change set">
      <meta name="deployment_region" content="IAD">
      <meta name="product" content="AWS CloudFormation">
      <meta name="guide" content="User Guide">
      <meta name="guide-locale" content="en_us">
      <link rel="icon" type="image/ico" href="/images/favicon.ico">
      <link rel="shortcut icon" type="image/ico" href="/images/favicon.ico">
      <link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/quickref-efs.html">
      <link rel="stylesheet" type="text/css" href="../../../css/jquery-ui.min.css">
      <link rel="stylesheet" type="text/css" href="../../../css/font-awesome.min.css">
      <link rel="stylesheet" type="text/css" href="../../../css/google-font.css">
      <link id="code-style" rel="stylesheet" type="text/css" href="../../../css/light.css">
      <link rel="stylesheet" type="text/css" href="../../../css/jquery-ui.theme.css">
      <link rel="stylesheet" type="text/css" href="../../../css/colorbox.css">
      <link rel="stylesheet" type="text/css" href="../../../css/awsdocs.css"><script type="text/javascript" src="/js/highlight.pack.js"></script><script type="text/javascript" src="/js/jquery.min.js"></script><script type="text/javascript" src="/js/jquery-ui.min.js"></script><script type="text/javascript" src="/js/handlebars.js"></script><script type="text/javascript" src="/js/jquery.colorbox.js"></script><script type="text/javascript" src="/js/awsdocs.min.js?v=20170615"></script></head>
   <body id="top">
      
      <div id="content-container">
         
         <div id="main-column">
            <div id="main">
               <div id="main-content">
                  <div id="main-col-body">
                     <table summary="Breadcrumbs">
                        <tbody><tr>
                           <td>
                              <div class="breadcrumb"><a href="http://aws.amazon.com/documentation">AWS Documentation</a> &#xBB; <a href="http://aws.amazon.com/documentation/cloudformation">AWS CloudFormation</a> &#xBB; <a href="index.html">User Guide</a> &#xBB; <a href="template-guide.html">Working with AWS CloudFormation Templates</a> &#xBB; <a href="CHAP_TemplateQuickRef.html">Template Snippets</a> &#xBB; <span class="breadcrumb">Amazon Elastic File System Sample Template</span></div>
                           </td>
                        </tr>
                     </tbody></table>
                     <div></div>
                     <div id="language-filter" class="page-header" style="display:none">
                        <form> Filter View: 
                           <select name="filter-select" id="filter-select">
                              <option selected="1">All</option>
                              <option value="JSON" selected>JSON</option>
                              <option value="YAML" selected>YAML</option></select></form>
                     </div>
                     <h1 class="topictitle" id="quickref-efs">Amazon Elastic File System Sample Template</h1>
                     <p>Amazon Elastic File System (Amazon EFS) is a file storage service for Amazon Elastic
                        Compute Cloud (Amazon EC2) instances. With Amazon EFS,
                        your applications have storage when they need it because storage capacity grows and
                        shrinks
                        automatically as you add and remove files.
                     </p>
                     <p>The following sample template deploys EC2 instances (in an Auto Scaling group) that
                        are associated
                        with an Amazon EFS file system. To associate the instances with the file system, the
                        instances run
                        the cfn-init helper script, which downloads and installs the <code class="code">nfs-utils</code> yum package,
                        creates a new directory, and then uses the file system&apos;s DNS name to mount the file
                        system at
                        that directory. The file system&apos;s DNS name resolves to a mount target&#x2019;s IP address
                        in the Amazon EC2
                        instance&apos;s Availability Zone. For more information about the DNS name structure, see
                        <a href="./efs/latest/ug/mounting-fs.html" target="_blank">Mounting File Systems</a> in the
                        <em>Amazon Elastic File System User Guide</em>.
                     </p>
                     <p>To measure Network File System activity, the template includes custom Amazon CloudWatch
                        metrics. The
                        template also creates a VPC, subnet, and security groups. To allow the instances to
                        communicate
                        with the file system, the VPC must have DNS enabled, and the mount target and the
                        EC2 instances
                        must be in the same Availability Zone (AZ), which is specified by the subnet.
                     </p>
                     <p>The security group of the mount target enables a network connection to TCP port 2049,
                        which
                        is required for an NFSv4 client to mount a file system. For more information on security
                        groups
                        for EC2 instances and mount targets, see <a href="./efs/latest/ug/security-considerations.html" target="_blank">Security</a> in the <a href="./efs/latest/ug/" target="_blank"><em>Amazon Elastic File System User Guide</em></a>.
                     </p>
                     <div class="aws-note">
                        <p class="aws-note">Note</p>
                        <p>If you make an update to the mount target that causes it to be replaced, instances
                           or
                           applications that use the associated file system might be disrupted. This can cause
                           uncommitted writes to be lost. To avoid disruption, stop your instances when you update
                           the
                           mount target by setting the desired capacity to zero. This allows the instances to
                           unmount the
                           file system before the mount target is deleted. After the mount update has completed,
                           start
                           your instances in a subsequent update by setting the desired capacity.
                        </p>
                     </div>
                     <div id="JSON" name="JSON" class="section langfilter">
                        <h2 id="quickref-efs-example-1.json">JSON</h2>
                        
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight ">{
  &quot;AWSTemplateFormatVersion&quot;: &quot;2010-09-09&quot;,
  &quot;Description&quot;: &quot;This template creates an Amazon EFS file system and mount target and associates it with Amazon EC2 instances in an Auto Scaling group. **WARNING** This template creates Amazon EC2 instances and related resources. You will be billed for the AWS resources used if you create a stack from this template.&quot;,
  &quot;Parameters&quot;: {
    &quot;InstanceType&quot; : {
      &quot;Description&quot; : &quot;WebServer EC2 instance type&quot;,
      &quot;Type&quot; : &quot;String&quot;,
      &quot;Default&quot; : &quot;m1.small&quot;,
      &quot;AllowedValues&quot; : [ &quot;t1.micro&quot;, &quot;t2.micro&quot;, &quot;t2.small&quot;, &quot;t2.medium&quot;, &quot;m1.small&quot;, &quot;m1.medium&quot;, &quot;m1.large&quot;, &quot;m1.xlarge&quot;, &quot;m2.xlarge&quot;, &quot;m2.2xlarge&quot;, &quot;m2.4xlarge&quot;, &quot;m3.medium&quot;, &quot;m3.large&quot;, &quot;m3.xlarge&quot;, &quot;m3.2xlarge&quot;, &quot;c1.medium&quot;, &quot;c1.xlarge&quot;, &quot;c3.large&quot;, &quot;c3.xlarge&quot;, &quot;c3.2xlarge&quot;, &quot;c3.4xlarge&quot;, &quot;c3.8xlarge&quot;, &quot;c4.large&quot;, &quot;c4.xlarge&quot;, &quot;c4.2xlarge&quot;, &quot;c4.4xlarge&quot;, &quot;c4.8xlarge&quot;, &quot;g2.2xlarge&quot;, &quot;r3.large&quot;, &quot;r3.xlarge&quot;, &quot;r3.2xlarge&quot;, &quot;r3.4xlarge&quot;, &quot;r3.8xlarge&quot;, &quot;i2.xlarge&quot;, &quot;i2.2xlarge&quot;, &quot;i2.4xlarge&quot;, &quot;i2.8xlarge&quot;, &quot;d2.xlarge&quot;, &quot;d2.2xlarge&quot;, &quot;d2.4xlarge&quot;, &quot;d2.8xlarge&quot;, &quot;hi1.4xlarge&quot;, &quot;hs1.8xlarge&quot;, &quot;cr1.8xlarge&quot;, &quot;cc2.8xlarge&quot;, &quot;cg1.4xlarge&quot;],
      &quot;ConstraintDescription&quot; : &quot;Must be a valid EC2 instance type.&quot;
    },
    &quot;KeyName&quot;: {
      &quot;Type&quot;: &quot;AWS::EC2::KeyPair::KeyName&quot;,
      &quot;Description&quot;: &quot;Name of an existing EC2 key pair to enable SSH access to the ECS instances&quot;
    },
    &quot;AsgMaxSize&quot;: {
      &quot;Type&quot;: &quot;Number&quot;,
      &quot;Description&quot;: &quot;Maximum size and initial desired capacity of Auto Scaling Group&quot;,
      &quot;Default&quot;: &quot;2&quot;
    },
    &quot;SSHLocation&quot; : {
      &quot;Description&quot; : &quot;The IP address range that can be used to connect to the EC2 instances by using SSH&quot;,
      &quot;Type&quot;: &quot;String&quot;,
      &quot;MinLength&quot;: &quot;9&quot;,
      &quot;MaxLength&quot;: &quot;18&quot;,
      &quot;Default&quot;: &quot;0.0.0.0/0&quot;,
      &quot;AllowedPattern&quot;: &quot;(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})&quot;,
      &quot;ConstraintDescription&quot;: &quot;must be a valid IP CIDR range of the form x.x.x.x/x.&quot;
    },
    &quot;VolumeName&quot; : {
      &quot;Description&quot; : &quot;The name to be used for the EFS volume&quot;,
      &quot;Type&quot;: &quot;String&quot;,
      &quot;MinLength&quot;: &quot;1&quot;,
      &quot;Default&quot;: &quot;myEFSvolume&quot;
    },
    &quot;MountPoint&quot; : {
      &quot;Description&quot; : &quot;The Linux mount point for the EFS volume&quot;,
      &quot;Type&quot;: &quot;String&quot;,
      &quot;MinLength&quot;: &quot;1&quot;,
      &quot;Default&quot;: &quot;myEFSvolume&quot;
    }
  },
  &quot;Mappings&quot; : {
    &quot;AWSInstanceType2Arch&quot; : {
      &quot;t1.micro&quot;    : { &quot;Arch&quot; : &quot;PV64&quot;   },
      &quot;t2.micro&quot;    : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;t2.small&quot;    : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;t2.medium&quot;   : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;m1.small&quot;    : { &quot;Arch&quot; : &quot;PV64&quot;   },
      &quot;m1.medium&quot;   : { &quot;Arch&quot; : &quot;PV64&quot;   },
      &quot;m1.large&quot;    : { &quot;Arch&quot; : &quot;PV64&quot;   },
      &quot;m1.xlarge&quot;   : { &quot;Arch&quot; : &quot;PV64&quot;   },
      &quot;m2.xlarge&quot;   : { &quot;Arch&quot; : &quot;PV64&quot;   },
      &quot;m2.2xlarge&quot;  : { &quot;Arch&quot; : &quot;PV64&quot;   },
      &quot;m2.4xlarge&quot;  : { &quot;Arch&quot; : &quot;PV64&quot;   },
      &quot;m3.medium&quot;   : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;m3.large&quot;    : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;m3.xlarge&quot;   : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;m3.2xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;c1.medium&quot;   : { &quot;Arch&quot; : &quot;PV64&quot;   },
      &quot;c1.xlarge&quot;   : { &quot;Arch&quot; : &quot;PV64&quot;   },
      &quot;c3.large&quot;    : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;c3.xlarge&quot;   : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;c3.2xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;c3.4xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;c3.8xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;c4.large&quot;    : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;c4.xlarge&quot;   : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;c4.2xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;c4.4xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;c4.8xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;g2.2xlarge&quot;  : { &quot;Arch&quot; : &quot;HVMG2&quot;  },
      &quot;r3.large&quot;    : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;r3.xlarge&quot;   : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;r3.2xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;r3.4xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;r3.8xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;i2.xlarge&quot;   : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;i2.2xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;i2.4xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;i2.8xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;d2.xlarge&quot;   : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;d2.2xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;d2.4xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;d2.8xlarge&quot;  : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;hi1.4xlarge&quot; : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;hs1.8xlarge&quot; : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;cr1.8xlarge&quot; : { &quot;Arch&quot; : &quot;HVM64&quot;  },
      &quot;cc2.8xlarge&quot; : { &quot;Arch&quot; : &quot;HVM64&quot;  }
    },
    &quot;AWSRegionArch2AMI&quot; : {
      &quot;us-east-1&quot;        : {&quot;PV64&quot; : &quot;ami-1ccae774&quot;, &quot;HVM64&quot; : &quot;ami-1ecae776&quot;, &quot;HVMG2&quot; : &quot;ami-8c6b40e4&quot;},
      &quot;us-west-2&quot;        : {&quot;PV64&quot; : &quot;ami-ff527ecf&quot;, &quot;HVM64&quot; : &quot;ami-e7527ed7&quot;, &quot;HVMG2&quot; : &quot;ami-abbe919b&quot;},
      &quot;us-west-1&quot;        : {&quot;PV64&quot; : &quot;ami-d514f291&quot;, &quot;HVM64&quot; : &quot;ami-d114f295&quot;, &quot;HVMG2&quot; : &quot;ami-f31ffeb7&quot;},
      &quot;eu-west-1&quot;        : {&quot;PV64&quot; : &quot;ami-bf0897c8&quot;, &quot;HVM64&quot; : &quot;ami-a10897d6&quot;, &quot;HVMG2&quot; : &quot;ami-d5bc24a2&quot;},
      &quot;eu-central-1&quot;     : {&quot;PV64&quot; : &quot;ami-ac221fb1&quot;, &quot;HVM64&quot; : &quot;ami-a8221fb5&quot;, &quot;HVMG2&quot; : &quot;ami-7cd2ef61&quot;},
      &quot;ap-northeast-1&quot;   : {&quot;PV64&quot; : &quot;ami-27f90e27&quot;, &quot;HVM64&quot; : &quot;ami-cbf90ecb&quot;, &quot;HVMG2&quot; : &quot;ami-6318e863&quot;},
      &quot;ap-southeast-1&quot;   : {&quot;PV64&quot; : &quot;ami-acd9e8fe&quot;, &quot;HVM64&quot; : &quot;ami-68d8e93a&quot;, &quot;HVMG2&quot; : &quot;ami-3807376a&quot;},
      &quot;ap-southeast-2&quot;   : {&quot;PV64&quot; : &quot;ami-ff9cecc5&quot;, &quot;HVM64&quot; : &quot;ami-fd9cecc7&quot;, &quot;HVMG2&quot; : &quot;ami-89790ab3&quot;},
      &quot;sa-east-1&quot;        : {&quot;PV64&quot; : &quot;ami-bb2890a6&quot;, &quot;HVM64&quot; : &quot;ami-b52890a8&quot;, &quot;HVMG2&quot; : &quot;NOT_SUPPORTED&quot;},
      &quot;cn-north-1&quot;       : {&quot;PV64&quot; : &quot;ami-fa39abc3&quot;, &quot;HVM64&quot; : &quot;ami-f239abcb&quot;, &quot;HVMG2&quot; : &quot;NOT_SUPPORTED&quot;}
    }
  },
  &quot;Resources&quot;: {
    &quot;CloudWatchPutMetricsRole&quot; : {
      &quot;Type&quot;  : &quot;AWS::IAM::Role&quot;,
      &quot;Properties&quot; : {
          &quot;AssumeRolePolicyDocument&quot; : {
              &quot;Statement&quot; : [ {
                  &quot;Effect&quot; : &quot;Allow&quot;,
                  &quot;Principal&quot; : {
                      &quot;Service&quot; : [ &quot;ec2.amazonaws.com&quot; ]
                  },
                  &quot;Action&quot; : [ &quot;sts:AssumeRole&quot; ]
              } ]
          },
          &quot;Path&quot; : &quot;/&quot;
      }
    },
    &quot;CloudWatchPutMetricsRolePolicy&quot; : {
        &quot;Type&quot; : &quot;AWS::IAM::Policy&quot;,
        &quot;Properties&quot; : {
            &quot;PolicyName&quot; : &quot;CloudWatch_PutMetricData&quot;,
            &quot;PolicyDocument&quot; : {
              &quot;Version&quot;: &quot;2012-10-17&quot;,
              &quot;Statement&quot;: [
                {
                  &quot;Sid&quot;: &quot;CloudWatchPutMetricData&quot;,
                  &quot;Effect&quot;: &quot;Allow&quot;,
                  &quot;Action&quot;: [&quot;cloudwatch:PutMetricData&quot;],
                  &quot;Resource&quot;: [&quot;*&quot;]
                }
              ]
            },
            &quot;Roles&quot; : [ { &quot;Ref&quot; : &quot;CloudWatchPutMetricsRole&quot; } ]
        }
    },
    &quot;CloudWatchPutMetricsInstanceProfile&quot; : {
      &quot;Type&quot; : &quot;AWS::IAM::InstanceProfile&quot;,
      &quot;Properties&quot; : {
        &quot;Path&quot; : &quot;/&quot;,
        &quot;Roles&quot; : [ { &quot;Ref&quot; : &quot;CloudWatchPutMetricsRole&quot; } ]
      }
    },
    &quot;VPC&quot;: {
      &quot;Type&quot;: &quot;AWS::EC2::VPC&quot;,
      &quot;Properties&quot;: {
        &quot;EnableDnsSupport&quot; : &quot;true&quot;,
        &quot;EnableDnsHostnames&quot; : &quot;true&quot;,
        &quot;CidrBlock&quot;: &quot;10.0.0.0/16&quot;,
        &quot;Tags&quot;: [ {&quot;Key&quot;: &quot;Application&quot;, &quot;Value&quot;: { &quot;Ref&quot;: &quot;AWS::StackId&quot;} } ]
      }
    },
    &quot;InternetGateway&quot; : {
      &quot;Type&quot; : &quot;AWS::EC2::InternetGateway&quot;,
      &quot;Properties&quot; : {
        &quot;Tags&quot; : [
          { &quot;Key&quot; : &quot;Application&quot;, &quot;Value&quot; : { &quot;Ref&quot; : &quot;AWS::StackName&quot; } },
          { &quot;Key&quot; : &quot;Network&quot;, &quot;Value&quot; : &quot;Public&quot; }
        ]
      }
    },
    &quot;GatewayToInternet&quot; : {
      &quot;Type&quot; : &quot;AWS::EC2::VPCGatewayAttachment&quot;,
      &quot;Properties&quot; : {
        &quot;VpcId&quot; : { &quot;Ref&quot; : &quot;VPC&quot; },
        &quot;InternetGatewayId&quot; : { &quot;Ref&quot; : &quot;InternetGateway&quot; }
      }
    },
    &quot;RouteTable&quot;:{
      &quot;Type&quot;:&quot;AWS::EC2::RouteTable&quot;,
      &quot;Properties&quot;:{
        &quot;VpcId&quot;: {&quot;Ref&quot;:&quot;VPC&quot;}
      }
    },
    &quot;SubnetRouteTableAssoc&quot;: {
      &quot;Type&quot; : &quot;AWS::EC2::SubnetRouteTableAssociation&quot;,
      &quot;Properties&quot; : {
        &quot;RouteTableId&quot; : {&quot;Ref&quot;:&quot;RouteTable&quot;},
        &quot;SubnetId&quot; : {&quot;Ref&quot;:&quot;Subnet&quot;}
      }
    },
    &quot;InternetGatewayRoute&quot;: {
        &quot;Type&quot;:&quot;AWS::EC2::Route&quot;,
        &quot;Properties&quot;:{
            &quot;DestinationCidrBlock&quot;:&quot;0.0.0.0/0&quot;,
            &quot;RouteTableId&quot;:{&quot;Ref&quot;:&quot;RouteTable&quot;},
            &quot;GatewayId&quot;:{&quot;Ref&quot;:&quot;InternetGateway&quot;}
        }
    },
    &quot;Subnet&quot;: {
      &quot;Type&quot;: &quot;AWS::EC2::Subnet&quot;,
      &quot;Properties&quot;: {
        &quot;VpcId&quot;: { &quot;Ref&quot;: &quot;VPC&quot; },
        &quot;CidrBlock&quot;: &quot;10.0.0.0/24&quot;,
        &quot;Tags&quot;: [ { &quot;Key&quot;: &quot;Application&quot;, &quot;Value&quot;: { &quot;Ref&quot;: &quot;AWS::StackId&quot; } } ]
      }
    },    
    &quot;InstanceSecurityGroup&quot;: {
      &quot;Type&quot;: &quot;AWS::EC2::SecurityGroup&quot;,
      &quot;Properties&quot;: {
        &quot;VpcId&quot;: { &quot;Ref&quot;: &quot;VPC&quot; },
        &quot;GroupDescription&quot;: &quot;Enable SSH access via port 22&quot;,
        &quot;SecurityGroupIngress&quot;: [
          { &quot;IpProtocol&quot;: &quot;tcp&quot;, &quot;FromPort&quot;: &quot;22&quot;, &quot;ToPort&quot;: &quot;22&quot;, &quot;CidrIp&quot;: { &quot;Ref&quot;: &quot;SSHLocation&quot; } },
          { &quot;IpProtocol&quot;: &quot;tcp&quot;, &quot;FromPort&quot;: &quot;80&quot;, &quot;ToPort&quot;: &quot;80&quot;, &quot;CidrIp&quot;: &quot;0.0.0.0/0&quot; }
         ]
      }
    },
    &quot;MountTargetSecurityGroup&quot;: {
      &quot;Type&quot;: &quot;AWS::EC2::SecurityGroup&quot;,
      &quot;Properties&quot;: {
        &quot;VpcId&quot;: { &quot;Ref&quot;: &quot;VPC&quot; },
        &quot;GroupDescription&quot;: &quot;Security group for mount target&quot;,
        &quot;SecurityGroupIngress&quot;: [
          {
            &quot;IpProtocol&quot;: &quot;tcp&quot;,
            &quot;FromPort&quot;: &quot;2049&quot;,
            &quot;ToPort&quot;: &quot;2049&quot;,
            &quot;CidrIp&quot;: &quot;0.0.0.0/0&quot;
          }
        ]
      }
    },
    &quot;FileSystem&quot;: {
      &quot;Type&quot;: &quot;AWS::EFS::FileSystem&quot;,
      &quot;Properties&quot;: {
        &quot;PerformanceMode&quot;: &quot;generalPurpose&quot;,
        &quot;FileSystemTags&quot;: [
          {
            &quot;Key&quot;: &quot;Name&quot;,
            &quot;Value&quot;: { &quot;Ref&quot; : &quot;VolumeName&quot; }
          }
        ]
      }
    },
    &quot;MountTarget&quot;: {
      &quot;Type&quot;: &quot;AWS::EFS::MountTarget&quot;,
      &quot;Properties&quot;: {
        &quot;FileSystemId&quot;: { &quot;Ref&quot;: &quot;FileSystem&quot; },
        &quot;SubnetId&quot;: { &quot;Ref&quot;: &quot;Subnet&quot; },
        &quot;SecurityGroups&quot;: [ { &quot;Ref&quot;: &quot;MountTargetSecurityGroup&quot; } ]        
      }
    },
    &quot;LaunchConfiguration&quot;: {
      &quot;Type&quot;: &quot;AWS::AutoScaling::LaunchConfiguration&quot;,
      &quot;Metadata&quot; : {
        &quot;AWS::CloudFormation::Init&quot; : {
          &quot;configSets&quot; : {
            &quot;MountConfig&quot; : [ &quot;setup&quot;, &quot;mount&quot; ]
          },
          &quot;setup&quot; : {
            &quot;packages&quot; : {
              &quot;yum&quot; : {
                &quot;nfs-utils&quot; : []
              }
            },
            &quot;files&quot; : {
              &quot;/home/ec2-user/post_nfsstat&quot; : {
                &quot;content&quot; : { &quot;Fn::Join&quot; : [ &quot;&quot;, [
                      &quot;#!/bin/bash\n&quot;,
                      &quot;\n&quot;,
                      &quot;INPUT=\&quot;$(cat)\&quot;\n&quot;,
                      &quot;CW_JSON_OPEN=&apos;{ \&quot;Namespace\&quot;: \&quot;EFS\&quot;, \&quot;MetricData\&quot;: [ &apos;\n&quot;,
                      &quot;CW_JSON_CLOSE=&apos; ] }&apos;\n&quot;,
                      &quot;CW_JSON_METRIC=&apos;&apos;\n&quot;,
                      &quot;METRIC_COUNTER=0\n&quot;,
                      &quot;\n&quot;,
                      &quot;for COL in 1 2 3 4 5 6; do\n&quot;,
                      &quot;\n&quot;,
                      &quot; COUNTER=0\n&quot;,
                      &quot; METRIC_FIELD=$COL\n&quot;,
                      &quot; DATA_FIELD=$(($COL+($COL-1)))\n&quot;,
                      &quot;\n&quot;,
                      &quot; while read line; do\n&quot;,
                      &quot;   if [[ COUNTER -gt 0 ]]; then\n&quot;,
                      &quot;\n&quot;,
                      &quot;     LINE=`echo $line | tr -s &apos; &apos; `\n&quot;,
                      &quot;     AWS_COMMAND=\&quot;aws cloudwatch put-metric-data --region &quot;, { &quot;Ref&quot;: &quot;AWS::Region&quot; }, &quot;\&quot;\n&quot;,
                      &quot;     MOD=$(( $COUNTER % 2))\n&quot;,
                      &quot;\n&quot;,
                      &quot;     if [ $MOD -eq 1 ]; then\n&quot;,
                      &quot;       METRIC_NAME=`echo $LINE | cut -d &apos; &apos; -f $METRIC_FIELD`\n&quot;,
                      &quot;     else\n&quot;,
                      &quot;       METRIC_VALUE=`echo $LINE | cut -d &apos; &apos; -f $DATA_FIELD`\n&quot;,
                      &quot;     fi\n&quot;,
                      &quot;\n&quot;,
                      &quot;     if [[ -n \&quot;$METRIC_NAME\&quot; &amp;&amp; -n \&quot;$METRIC_VALUE\&quot; ]]; then\n&quot;,
                      &quot;       INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n&quot;,
                      &quot;       CW_JSON_METRIC=\&quot;$CW_JSON_METRIC { \\\&quot;MetricName\\\&quot;: \\\&quot;$METRIC_NAME\\\&quot;, \\\&quot;Dimensions\\\&quot;: [{\\\&quot;Name\\\&quot;: \\\&quot;InstanceId\\\&quot;, \\\&quot;Value\\\&quot;: \\\&quot;$INSTANCE_ID\\\&quot;} ], \\\&quot;Value\\\&quot;: $METRIC_VALUE },\&quot;\n&quot;,
                      &quot;       unset METRIC_NAME\n&quot;,
                      &quot;       unset METRIC_VALUE\n&quot;,
                      &quot;\n&quot;,
                      &quot;       METRIC_COUNTER=$((METRIC_COUNTER+1))\n&quot;,
                      &quot;       if [ $METRIC_COUNTER -eq 20 ]; then\n&quot;,
                      &quot;         # 20 is max metric collection size, so we have to submit here\n&quot;,
                      &quot;         aws cloudwatch put-metric-data --region &quot;, { &quot;Ref&quot;: &quot;AWS::Region&quot; }, &quot; --cli-input-json \&quot;`echo $CW_JSON_OPEN ${CW_JSON_METRIC%?} $CW_JSON_CLOSE`\&quot;\n&quot;,
                      &quot;\n&quot;,
                      &quot;         # reset\n&quot;,
                      &quot;         METRIC_COUNTER=0\n&quot;,
                      &quot;         CW_JSON_METRIC=&apos;&apos;\n&quot;,
                      &quot;       fi\n&quot;,
                      &quot;     fi  \n&quot;,
                      &quot;\n&quot;,
                      &quot;\n&quot;,
                      &quot;\n&quot;,
                      &quot;     COUNTER=$((COUNTER+1))\n&quot;,
                      &quot;   fi\n&quot;,
                      &quot;\n&quot;,
                      &quot;   if [[ \&quot;$line\&quot; == \&quot;Client nfs v4:\&quot; ]]; then\n&quot;,
                      &quot;     # the next line is the good stuff \n&quot;,
                      &quot;     COUNTER=$((COUNTER+1))\n&quot;,
                      &quot;   fi\n&quot;,
                      &quot; done &lt;&lt;&lt; \&quot;$INPUT\&quot;\n&quot;,
                      &quot;done\n&quot;,
                      &quot;\n&quot;,
                      &quot;# submit whatever is left\n&quot;,
                      &quot;aws cloudwatch put-metric-data --region &quot;, { &quot;Ref&quot;: &quot;AWS::Region&quot; }, &quot; --cli-input-json \&quot;`echo $CW_JSON_OPEN ${CW_JSON_METRIC%?} $CW_JSON_CLOSE`\&quot;&quot;
                    ] ] },
                &quot;mode&quot;: &quot;000755&quot;,
                &quot;owner&quot;: &quot;ec2-user&quot;,
                &quot;group&quot;: &quot;ec2-user&quot;
              },
              &quot;/home/ec2-user/crontab&quot; : {
                &quot;content&quot; : { &quot;Fn::Join&quot; : [ &quot;&quot;, [
                  &quot;* * * * * /usr/sbin/nfsstat | /home/ec2-user/post_nfsstat\n&quot;
                ] ] },
                &quot;owner&quot;: &quot;ec2-user&quot;,
                &quot;group&quot;: &quot;ec2-user&quot;
              }
            },
            &quot;commands&quot; : {
              &quot;01_createdir&quot; : {
                &quot;command&quot; : {&quot;Fn::Join&quot; : [ &quot;&quot;, [ &quot;mkdir /&quot;, { &quot;Ref&quot; : &quot;MountPoint&quot; }]]}
              }
            }
          },
          &quot;mount&quot; : {
            &quot;commands&quot; : {
              &quot;01_mount&quot; : {
                &quot;command&quot; : { &quot;Fn::Sub&quot;: &quot;sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 ${FileSystem}.efs.${AWS::Region}.amazonaws.com:/ /${MountPoint}&quot;}
              },
              &quot;02_permissions&quot; : {
                &quot;command&quot; : {&quot;Fn::Join&quot; : [ &quot;&quot;, [ &quot;chown ec2-user:ec2-user /&quot;, { &quot;Ref&quot; : &quot;MountPoint&quot; }]]}
              }
            }
          }
        }
      },
      &quot;Properties&quot;: {
        &quot;AssociatePublicIpAddress&quot; : true,
        &quot;ImageId&quot;: {
          &quot;Fn::FindInMap&quot;: [ &quot;AWSRegionArch2AMI&quot;, { &quot;Ref&quot;: &quot;AWS::Region&quot; }, {
            &quot;Fn::FindInMap&quot;: [ &quot;AWSInstanceType2Arch&quot;, { &quot;Ref&quot;: &quot;InstanceType&quot; }, &quot;Arch&quot; ]
          } ]
        },
        &quot;InstanceType&quot;: { &quot;Ref&quot;: &quot;InstanceType&quot; },
        &quot;KeyName&quot;: { &quot;Ref&quot;: &quot;KeyName&quot; },
        &quot;SecurityGroups&quot;: [ { &quot;Ref&quot;: &quot;InstanceSecurityGroup&quot; } ],
        &quot;IamInstanceProfile&quot; : { &quot;Ref&quot; : &quot;CloudWatchPutMetricsInstanceProfile&quot; },
        &quot;UserData&quot;       : { &quot;Fn::Base64&quot; : { &quot;Fn::Join&quot; : [&quot;&quot;, [
             &quot;#!/bin/bash -xe\n&quot;,
             &quot;yum install -y aws-cfn-bootstrap\n&quot;,

             &quot;/opt/aws/bin/cfn-init -v &quot;,
             &quot;         --stack &quot;, { &quot;Ref&quot; : &quot;AWS::StackName&quot; },
             &quot;         --resource LaunchConfiguration &quot;,
             &quot;         --configsets MountConfig &quot;,
             &quot;         --region &quot;, { &quot;Ref&quot; : &quot;AWS::Region&quot; }, &quot;\n&quot;,

             &quot;crontab /home/ec2-user/crontab\n&quot;,

             &quot;/opt/aws/bin/cfn-signal -e $? &quot;,
             &quot;         --stack &quot;, { &quot;Ref&quot; : &quot;AWS::StackName&quot; },
             &quot;         --resource AutoScalingGroup &quot;,
             &quot;         --region &quot;, { &quot;Ref&quot; : &quot;AWS::Region&quot; }, &quot;\n&quot;
        ]]}}
      }
    },
    &quot;AutoScalingGroup&quot;: {
      &quot;Type&quot;: &quot;AWS::AutoScaling::AutoScalingGroup&quot;,
      &quot;DependsOn&quot;: [&quot;MountTarget&quot;, &quot;GatewayToInternet&quot;],
      &quot;CreationPolicy&quot; : {
        &quot;ResourceSignal&quot; : {
          &quot;Timeout&quot; : &quot;PT15M&quot;,
          &quot;Count&quot;   : { &quot;Ref&quot;: &quot;AsgMaxSize&quot; }
        }
      },
      &quot;Properties&quot;: {
        &quot;VPCZoneIdentifier&quot;: [ { &quot;Ref&quot;: &quot;Subnet&quot; } ],
        &quot;LaunchConfigurationName&quot;: { &quot;Ref&quot;: &quot;LaunchConfiguration&quot; },
        &quot;MinSize&quot;: &quot;1&quot;,
        &quot;MaxSize&quot;: { &quot;Ref&quot;: &quot;AsgMaxSize&quot; },
        &quot;DesiredCapacity&quot;: { &quot;Ref&quot;: &quot;AsgMaxSize&quot; },
        &quot;Tags&quot;: [ {
          &quot;Key&quot;: &quot;Name&quot;,
          &quot;Value&quot;: &quot;EFS FileSystem Mounted Instance&quot;,
          &quot;PropagateAtLaunch&quot;: &quot;true&quot;
        } ]
      }
    }
  },
  &quot;Outputs&quot; : {
    &quot;MountTargetID&quot; : {
      &quot;Description&quot; : &quot;Mount target ID&quot;,
      &quot;Value&quot; :  { &quot;Ref&quot; : &quot;MountTarget&quot; }
    },
    &quot;FileSystemID&quot; : {
      &quot;Description&quot; : &quot;File system ID&quot;,
      &quot;Value&quot; :  { &quot;Ref&quot; : &quot;FileSystem&quot; }
    }
  }
}</code></pre>
                        </div>
                     <div id="YAML" name="YAML" class="section langfilter">
                        <h2 id="quickref-efs-example-1.yaml">YAML</h2>
                        
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight ">AWSTemplateFormatVersion: &apos;2010-09-09&apos;
Description: This template creates an Amazon EFS file system and mount target and
  associates it with Amazon EC2 instances in an Auto Scaling group. **WARNING** This
  template creates Amazon EC2 instances and related resources. You will be billed
  for the AWS resources used if you create a stack from this template.
Parameters:
  InstanceType:
    Description: WebServer EC2 instance type
    Type: String
    Default: m1.small
    AllowedValues:
    - t1.micro
    - t2.micro
    - t2.small
    - t2.medium
    - m1.small
    - m1.medium
    - m1.large
    - m1.xlarge
    - m2.xlarge
    - m2.2xlarge
    - m2.4xlarge
    - m3.medium
    - m3.large
    - m3.xlarge
    - m3.2xlarge
    - c1.medium
    - c1.xlarge
    - c3.large
    - c3.xlarge
    - c3.2xlarge
    - c3.4xlarge
    - c3.8xlarge
    - c4.large
    - c4.xlarge
    - c4.2xlarge
    - c4.4xlarge
    - c4.8xlarge
    - g2.2xlarge
    - r3.large
    - r3.xlarge
    - r3.2xlarge
    - r3.4xlarge
    - r3.8xlarge
    - i2.xlarge
    - i2.2xlarge
    - i2.4xlarge
    - i2.8xlarge
    - d2.xlarge
    - d2.2xlarge
    - d2.4xlarge
    - d2.8xlarge
    - hi1.4xlarge
    - hs1.8xlarge
    - cr1.8xlarge
    - cc2.8xlarge
    - cg1.4xlarge
    ConstraintDescription: Must be a valid EC2 instance type.
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 key pair to enable SSH access to the ECS
      instances
  AsgMaxSize:
    Type: Number
    Description: Maximum size and initial desired capacity of Auto Scaling Group
    Default: &apos;2&apos;
  SSHLocation:
    Description: The IP address range that can be used to connect to the EC2 instances
      by using SSH
    Type: String
    MinLength: &apos;9&apos;
    MaxLength: &apos;18&apos;
    Default: 0.0.0.0/0
    AllowedPattern: &quot;(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})&quot;
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
  VolumeName:
    Description: The name to be used for the EFS volume
    Type: String
    MinLength: &apos;1&apos;
    Default: myEFSvolume
  MountPoint:
    Description: The Linux mount point for the EFS volume
    Type: String
    MinLength: &apos;1&apos;
    Default: myEFSvolume
Mappings:
  AWSInstanceType2Arch:
    t1.micro:
      Arch: PV64
    t2.micro:
      Arch: HVM64
    t2.small:
      Arch: HVM64
    t2.medium:
      Arch: HVM64
    m1.small:
      Arch: PV64
    m1.medium:
      Arch: PV64
    m1.large:
      Arch: PV64
    m1.xlarge:
      Arch: PV64
    m2.xlarge:
      Arch: PV64
    m2.2xlarge:
      Arch: PV64
    m2.4xlarge:
      Arch: PV64
    m3.medium:
      Arch: HVM64
    m3.large:
      Arch: HVM64
    m3.xlarge:
      Arch: HVM64
    m3.2xlarge:
      Arch: HVM64
    c1.medium:
      Arch: PV64
    c1.xlarge:
      Arch: PV64
    c3.large:
      Arch: HVM64
    c3.xlarge:
      Arch: HVM64
    c3.2xlarge:
      Arch: HVM64
    c3.4xlarge:
      Arch: HVM64
    c3.8xlarge:
      Arch: HVM64
    c4.large:
      Arch: HVM64
    c4.xlarge:
      Arch: HVM64
    c4.2xlarge:
      Arch: HVM64
    c4.4xlarge:
      Arch: HVM64
    c4.8xlarge:
      Arch: HVM64
    g2.2xlarge:
      Arch: HVMG2
    r3.large:
      Arch: HVM64
    r3.xlarge:
      Arch: HVM64
    r3.2xlarge:
      Arch: HVM64
    r3.4xlarge:
      Arch: HVM64
    r3.8xlarge:
      Arch: HVM64
    i2.xlarge:
      Arch: HVM64
    i2.2xlarge:
      Arch: HVM64
    i2.4xlarge:
      Arch: HVM64
    i2.8xlarge:
      Arch: HVM64
    d2.xlarge:
      Arch: HVM64
    d2.2xlarge:
      Arch: HVM64
    d2.4xlarge:
      Arch: HVM64
    d2.8xlarge:
      Arch: HVM64
    hi1.4xlarge:
      Arch: HVM64
    hs1.8xlarge:
      Arch: HVM64
    cr1.8xlarge:
      Arch: HVM64
    cc2.8xlarge:
      Arch: HVM64
  AWSRegionArch2AMI:
    us-east-1:
      PV64: ami-1ccae774
      HVM64: ami-1ecae776
      HVMG2: ami-8c6b40e4
    us-west-2:
      PV64: ami-ff527ecf
      HVM64: ami-e7527ed7
      HVMG2: ami-abbe919b
    us-west-1:
      PV64: ami-d514f291
      HVM64: ami-d114f295
      HVMG2: ami-f31ffeb7
    eu-west-1:
      PV64: ami-bf0897c8
      HVM64: ami-a10897d6
      HVMG2: ami-d5bc24a2
    eu-central-1:
      PV64: ami-ac221fb1
      HVM64: ami-a8221fb5
      HVMG2: ami-7cd2ef61
    ap-northeast-1:
      PV64: ami-27f90e27
      HVM64: ami-cbf90ecb
      HVMG2: ami-6318e863
    ap-southeast-1:
      PV64: ami-acd9e8fe
      HVM64: ami-68d8e93a
      HVMG2: ami-3807376a
    ap-southeast-2:
      PV64: ami-ff9cecc5
      HVM64: ami-fd9cecc7
      HVMG2: ami-89790ab3
    sa-east-1:
      PV64: ami-bb2890a6
      HVM64: ami-b52890a8
      HVMG2: NOT_SUPPORTED
    cn-north-1:
      PV64: ami-fa39abc3
      HVM64: ami-f239abcb
      HVMG2: NOT_SUPPORTED
Resources:
  CloudWatchPutMetricsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: &quot;/&quot;
  CloudWatchPutMetricsRolePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: CloudWatch_PutMetricData
      PolicyDocument:
        Version: &apos;2012-10-17&apos;
        Statement:
        - Sid: CloudWatchPutMetricData
          Effect: Allow
          Action:
          - cloudwatch:PutMetricData
          Resource:
          - &quot;*&quot;
      Roles:
      - Ref: CloudWatchPutMetricsRole
  CloudWatchPutMetricsInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: &quot;/&quot;
      Roles:
      - Ref: CloudWatchPutMetricsRole
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      EnableDnsSupport: &apos;true&apos;
      EnableDnsHostnames: &apos;true&apos;
      CidrBlock: 10.0.0.0/16
      Tags:
      - Key: Application
        Value:
          Ref: AWS::StackId
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
      - Key: Application
        Value:
          Ref: AWS::StackName
      - Key: Network
        Value: Public
  GatewayToInternet:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:
        Ref: VPC
      InternetGatewayId:
        Ref: InternetGateway
  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: VPC
  SubnetRouteTableAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: RouteTable
      SubnetId:
        Ref: Subnet
  InternetGatewayRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      RouteTableId:
        Ref: RouteTable
      GatewayId:
        Ref: InternetGateway
  Subnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      CidrBlock: 10.0.0.0/24
      Tags:
      - Key: Application
        Value:
          Ref: AWS::StackId
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId:
        Ref: VPC
      GroupDescription: Enable SSH access via port 22
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: &apos;22&apos;
        ToPort: &apos;22&apos;
        CidrIp:
          Ref: SSHLocation
      - IpProtocol: tcp
        FromPort: &apos;80&apos;
        ToPort: &apos;80&apos;
        CidrIp: 0.0.0.0/0
  MountTargetSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId:
        Ref: VPC
      GroupDescription: Security group for mount target
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: &apos;2049&apos;
        ToPort: &apos;2049&apos;
        CidrIp: 0.0.0.0/0
  FileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      PerformanceMode: generalPurpose
      FileSystemTags:
      - Key: Name
        Value:
          Ref: VolumeName
  MountTarget:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId:
        Ref: FileSystem
      SubnetId:
        Ref: Subnet
      SecurityGroups:
      - Ref: MountTargetSecurityGroup
  LaunchConfiguration:
    Type: AWS::AutoScaling::LaunchConfiguration
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          MountConfig:
          - setup
          - mount
        setup:
          packages:
            yum:
              nfs-utils: []
          files:
            &quot;/home/ec2-user/post_nfsstat&quot;:
              content: !Sub |
                #!/bin/bash

                INPUT=&quot;$(cat)&quot;
                CW_JSON_OPEN=&apos;{ &quot;Namespace&quot;: &quot;EFS&quot;, &quot;MetricData&quot;: [ &apos;
                CW_JSON_CLOSE=&apos; ] }&apos;
                CW_JSON_METRIC=&apos;&apos;
                METRIC_COUNTER=0

                for COL in 1 2 3 4 5 6; do

                 COUNTER=0
                 METRIC_FIELD=$COL
                 DATA_FIELD=$(($COL+($COL-1)))

                 while read line; do
                   if [[ COUNTER -gt 0 ]]; then

                     LINE=`echo $line | tr -s &apos; &apos; `
                     AWS_COMMAND=&quot;aws cloudwatch put-metric-data --region ${AWS::Region}&quot;
                     MOD=$(( $COUNTER % 2))

                     if [ $MOD -eq 1 ]; then
                       METRIC_NAME=`echo $LINE | cut -d &apos; &apos; -f $METRIC_FIELD`
                     else
                       METRIC_VALUE=`echo $LINE | cut -d &apos; &apos; -f $DATA_FIELD`
                     fi

                     if [[ -n &quot;$METRIC_NAME&quot; &amp;&amp; -n &quot;$METRIC_VALUE&quot; ]]; then
                       INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
                       CW_JSON_METRIC=&quot;$CW_JSON_METRIC { \&quot;MetricName\&quot;: \&quot;$METRIC_NAME\&quot;, \&quot;Dimensions\&quot;: [{\&quot;Name\&quot;: \&quot;InstanceId\&quot;, \&quot;Value\&quot;: \&quot;$INSTANCE_ID\&quot;} ], \&quot;Value\&quot;: $METRIC_VALUE },&quot;
                       unset METRIC_NAME
                       unset METRIC_VALUE

                       METRIC_COUNTER=$((METRIC_COUNTER+1))
                       if [ $METRIC_COUNTER -eq 20 ]; then
                         # 20 is max metric collection size, so we have to submit here
                         aws cloudwatch put-metric-data --region ${AWS::Region} --cli-input-json &quot;`echo $CW_JSON_OPEN ${!CW_JSON_METRIC%?} $CW_JSON_CLOSE`&quot;

                         # reset
                         METRIC_COUNTER=0
                         CW_JSON_METRIC=&apos;&apos;
                       fi
                     fi



                     COUNTER=$((COUNTER+1))
                   fi

                   if [[ &quot;$line&quot; == &quot;Client nfs v4:&quot; ]]; then
                     # the next line is the good stuff
                     COUNTER=$((COUNTER+1))
                   fi
                 done &lt;&lt;&lt; &quot;$INPUT&quot;
                done

                # submit whatever is left
                aws cloudwatch put-metric-data --region ${AWS::Region} --cli-input-json &quot;`echo $CW_JSON_OPEN ${!CW_JSON_METRIC%?} $CW_JSON_CLOSE`&quot;
              mode: &apos;000755&apos;
              owner: ec2-user
              group: ec2-user
            &quot;/home/ec2-user/crontab&quot;:
              content: &quot;* * * * * /usr/sbin/nfsstat | /home/ec2-user/post_nfsstat\n&quot;
              owner: ec2-user
              group: ec2-user
          commands:
            01_createdir:
              command: !Sub &quot;mkdir /${MountPoint}&quot;
        mount:
          commands:
            01_mount:
              command: !Sub &gt;
                mount -t nfs4 -o nfsvers=4.1 ${FileSystem}.efs.${AWS::Region}.amazonaws.com:/ /${MountPoint}
            02_permissions:
              command: !Sub &quot;chown ec2-user:ec2-user /${MountPoint}&quot;
    Properties:
      AssociatePublicIpAddress: true
      ImageId:
        Fn::FindInMap:
        - AWSRegionArch2AMI
        - Ref: AWS::Region
        - Fn::FindInMap:
          - AWSInstanceType2Arch
          - Ref: InstanceType
          - Arch
      InstanceType:
        Ref: InstanceType
      KeyName:
        Ref: KeyName
      SecurityGroups:
      - Ref: InstanceSecurityGroup
      IamInstanceProfile:
        Ref: CloudWatchPutMetricsInstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          yum install -y aws-cfn-bootstrap
          /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource LaunchConfiguration --configsets MountConfig --region ${AWS::Region}
          crontab /home/ec2-user/crontab
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource AutoScalingGroup --region ${AWS::Region}
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    DependsOn:
    - MountTarget
    - GatewayToInternet
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
        Count:
          Ref: AsgMaxSize
    Properties:
      VPCZoneIdentifier:
      - Ref: Subnet
      LaunchConfigurationName:
        Ref: LaunchConfiguration
      MinSize: &apos;1&apos;
      MaxSize:
        Ref: AsgMaxSize
      DesiredCapacity:
        Ref: AsgMaxSize
      Tags:
      - Key: Name
        Value: EFS FileSystem Mounted Instance
        PropagateAtLaunch: &apos;true&apos;
Outputs:
  MountTargetID:
    Description: Mount target ID
    Value:
      Ref: MountTarget
  FileSystemID:
    Description: File system ID
    Value:
      Ref: FileSystem</code></pre>
                        </div>
                  </div>
                  <noscript>
                     <div>
                        <div>
                           <div>
                              <div id="js_error_message">
                                 <p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p>
                                 <p>To use the AWS Documentation, Javascript must be enabled. Please refer to your browser's
                                    Help pages for instructions.
                                 </p>
                              </div>
                           </div>
                        </div>
                     </div>
                  </noscript>
                  <div id="main-col-footer">
                     <div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div>
                     <div id="next"><a class="awstoc" accesskey="p" href="quickref-ecs.html">&#xAB; Previous </a><a class="awstoc" accesskey="n" href="quickref-elasticbeanstalk.html">Next &#xBB;</a></div>
                     <div id="copyright-main-footer">&#xA9; 2018, Amazon Web Services, Inc. or its affiliates. All rights reserved.</div>
                  </div>
               </div>
            </div>
            <div id="right-expanded">
               <div id="right-content-wrapper">
                  <div id="pagetoc">
                     <p>On this page:</p>
                     <ul class="pagetoc">
                        <li class="pagetoc" name="JSON"><a class="pagetoc" href="#quickref-efs-example-1.json">JSON</a></li>
                        <li class="pagetoc" name="YAML"><a class="pagetoc" href="#quickref-efs-example-1.yaml">YAML</a></li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      </div>
      
      <!-- SiteCatalyst code version: H.25.2.
            Copyright 1996-2012 Adobe, Inc. All Rights Reserved
            More info available at http://www.omniture.com --><script language="JavaScript" type="text/javascript" src="https://a0.awsstatic.com/s_code/js/1.0/awshome_s_code.js"></script><script language="JavaScript" type="text/javascript">
         <!--

            // Documentation Service Name
            s.prop66='AWS CloudFormation';
            s.eVar66='D=c66';
  
            // Documentation Guide Name                                                                 
            s.prop65='User Guide';
            s.eVar65='D=c65';

            var s_code=s.t();if(s_code)document.write(s_code)//--></script><script language="JavaScript" type="text/javascript">
         <!--
                if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
                //--></script><noscript><img src="https://amazonwebservices.d2.sc.omtrdc.net/b/ss/awsamazondev/1/H.25.2--NS/0" height="1" width="1" border="0" alt="" /></noscript>
      <!--/DO NOT REMOVE/-->
      <!-- End SiteCatalyst code version: H.25.2. -->
   
</body></html>